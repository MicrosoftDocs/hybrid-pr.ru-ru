---
title: Шаблон Kubernetes с высоким уровнем доступности в Azure и Azure Stack Hub
description: Узнайте, как решение кластера Kubernetes обеспечивает высокий уровень доступности с помощью Azure и Azure Stack Hub.
author: BryanLa
ms.topic: article
ms.date: 12/03/2020
ms.author: bryanla
ms.reviewer: bryanla
ms.lastreviewed: 12/03/2020
ms.openlocfilehash: 454cc0a0531882b7a8ec050a461420ce13eebcfe
ms.sourcegitcommit: df7e3e6423c3d4e8a42dae3d1acfba1d55057258
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/09/2020
ms.locfileid: "96912005"
---
# <a name="high-availability-kubernetes-cluster-pattern"></a><span data-ttu-id="35d4f-103">Шаблон кластера Kubernetes с высоким уровнем доступности</span><span class="sxs-lookup"><span data-stu-id="35d4f-103">High availability Kubernetes cluster pattern</span></span>

<span data-ttu-id="35d4f-104">В этой статье описывается, как спроектировать и использовать высокодоступную инфраструктуру на основе Kubernetes с помощью обработчика Службы Azure Kubernetes (AKS) в Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-104">This article describes how to architect and operate a highly available Kubernetes-based infrastructure using Azure Kubernetes Service (AKS) Engine on Azure Stack Hub.</span></span> <span data-ttu-id="35d4f-105">Этот сценарий часто используется для организаций с критически важными рабочими нагрузками в средах с высоким уровнем ограничений и регулирования.</span><span class="sxs-lookup"><span data-stu-id="35d4f-105">This scenario is common for organizations with critical workloads in highly restricted and regulated environments.</span></span> <span data-ttu-id="35d4f-106">А также для государственных, финансовых и оборонных организаций.</span><span class="sxs-lookup"><span data-stu-id="35d4f-106">Organizations in domains such as finance, defense, and government.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="35d4f-107">Контекст и проблема</span><span class="sxs-lookup"><span data-stu-id="35d4f-107">Context and problem</span></span>

<span data-ttu-id="35d4f-108">Многие организации разрабатывают полностью облачные решения, которые используют современные службы и технологии, такие как Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="35d4f-108">Many organizations are developing cloud-native solutions that leverage state-of-the-art services and technologies like Kubernetes.</span></span> <span data-ttu-id="35d4f-109">Хотя Azure предоставляет центры обработки данных в большинстве регионов мира, иногда возникают определенные варианты использования и сценарии, в которых критически важные для бизнеса приложения должны выполняться в определенном расположении.</span><span class="sxs-lookup"><span data-stu-id="35d4f-109">Although Azure provides datacenters in most regions of the world, sometimes there are edge use-cases and scenarios where business critical applications must run in a specific location.</span></span> <span data-ttu-id="35d4f-110">С этим связаны такие аспекты:</span><span class="sxs-lookup"><span data-stu-id="35d4f-110">Considerations include:</span></span>

- <span data-ttu-id="35d4f-111">чувствительность к расположению;</span><span class="sxs-lookup"><span data-stu-id="35d4f-111">Location sensitivity</span></span>
- <span data-ttu-id="35d4f-112">задержка между приложением и локальными системами;</span><span class="sxs-lookup"><span data-stu-id="35d4f-112">Latency between the application and on-premises systems</span></span>
- <span data-ttu-id="35d4f-113">сохранение пропускной способности;</span><span class="sxs-lookup"><span data-stu-id="35d4f-113">Bandwidth conservation</span></span>
- <span data-ttu-id="35d4f-114">Соединение</span><span class="sxs-lookup"><span data-stu-id="35d4f-114">Connectivity</span></span>
- <span data-ttu-id="35d4f-115">нормативные или предусмотренные законом требования.</span><span class="sxs-lookup"><span data-stu-id="35d4f-115">Regulatory or statutory requirements</span></span>

<span data-ttu-id="35d4f-116">Azure в сочетании с Azure Stack Hub устраняет большинство этих проблем.</span><span class="sxs-lookup"><span data-stu-id="35d4f-116">Azure, in combination with Azure Stack Hub, addresses most of these concerns.</span></span> <span data-ttu-id="35d4f-117">Ниже приведен широкий набор возможностей, решений и рекомендаций для успешной реализации Kubernetes под управлением Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-117">A broad set of options, decisions, and considerations for a successful implementation of Kubernetes running on Azure Stack Hub is described below.</span></span>

## <a name="solution"></a><span data-ttu-id="35d4f-118">Решение</span><span class="sxs-lookup"><span data-stu-id="35d4f-118">Solution</span></span>

<span data-ttu-id="35d4f-119">При работе с этим шаблоном приходится иметь дело со строгим набором ограничений.</span><span class="sxs-lookup"><span data-stu-id="35d4f-119">This pattern assumes that we have to deal with a strict set of constraints.</span></span> <span data-ttu-id="35d4f-120">Приложение должно выполняться локально, а все персональные данные не должны быть переданы в общедоступные облачные службы.</span><span class="sxs-lookup"><span data-stu-id="35d4f-120">The application must run on-premises and all personal data must not reach public cloud services.</span></span> <span data-ttu-id="35d4f-121">Данные мониторинга и другие неперсональные данные могут быть отправлены в Azure и обрабатываться там.</span><span class="sxs-lookup"><span data-stu-id="35d4f-121">Monitoring and other non-PII data can be sent to Azure and be processed there.</span></span> <span data-ttu-id="35d4f-122">Вы можете осуществлять доступ к внешним службам, например общедоступному реестру контейнеров и т. д. Но, возможно, потребуется отфильтровать их трафик с помощью брандмауэра или прокси-сервера.</span><span class="sxs-lookup"><span data-stu-id="35d4f-122">External services like a public Container Registry or others can be accessed but might be filtered through a firewall or proxy server.</span></span>

<span data-ttu-id="35d4f-123">Приведенный здесь пример приложения (на основе данных [семинара по Azure Kubernetes Service Workshop](/learn/modules/aks-workshop/)) предназначен для использования собственных решений Kubernetes, если это возможно.</span><span class="sxs-lookup"><span data-stu-id="35d4f-123">The sample application shown here (based on [Azure Kubernetes Service Workshop](/learn/modules/aks-workshop/)) is designed to use Kubernetes-native solutions whenever possible.</span></span> <span data-ttu-id="35d4f-124">В этой схеме не используются собственные службы платформы. Это позволяет избежать привязки к поставщику.</span><span class="sxs-lookup"><span data-stu-id="35d4f-124">This design avoids vendor lock-in, instead of using platform-native services.</span></span> <span data-ttu-id="35d4f-125">Например, приложение использует локальную серверную часть базы данных MongoDB вместо службы PaaS или внешней службы базы данных.</span><span class="sxs-lookup"><span data-stu-id="35d4f-125">As an example, the application uses a self-hosted MongoDB database backend instead of a PaaS service or external database service.</span></span>

<span data-ttu-id="35d4f-126">[![Гибридный шаблон приложения](media/pattern-highly-available-kubernetes/application-architecture.png)](media/pattern-highly-available-kubernetes/application-architecture.png#lightbox)</span><span class="sxs-lookup"><span data-stu-id="35d4f-126">[![Application Pattern Hybrid](media/pattern-highly-available-kubernetes/application-architecture.png)](media/pattern-highly-available-kubernetes/application-architecture.png#lightbox)</span></span>

<span data-ttu-id="35d4f-127">На предыдущей схеме показана архитектура примера приложения под управлением Kubernetes в Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-127">The preceding diagram illustrates the application architecture of the sample application running on Kubernetes on Azure Stack Hub.</span></span> <span data-ttu-id="35d4f-128">Приложение состоит из нескольких компонентов, включая указанные ниже:</span><span class="sxs-lookup"><span data-stu-id="35d4f-128">The app consists of several components, including:</span></span>

 1) <span data-ttu-id="35d4f-129">Кластер Kubernetes на основе обработчика AKS в Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-129">An AKS Engine based Kubernetes cluster on Azure Stack Hub.</span></span>
 2) <span data-ttu-id="35d4f-130">[cert-manager](https://www.jetstack.io/cert-manager/): предоставляет набор средств для управления сертификатами в Kubernetes и используется для автоматического запроса сертификатов из Let's Encrypt.</span><span class="sxs-lookup"><span data-stu-id="35d4f-130">[cert-manager](https://www.jetstack.io/cert-manager/), which provides a suite of tools for certificate management in Kubernetes, used to automatically request certificates from Let's Encrypt.</span></span>
 3) <span data-ttu-id="35d4f-131">Пространство имен Kubernetes, содержащее компоненты приложения для внешнего интерфейса (ratings-web), API (ratings-api) и базы данных (ratings-mongodb).</span><span class="sxs-lookup"><span data-stu-id="35d4f-131">A Kubernetes namespace that contains the application components for the front end (ratings-web), api (ratings-api), and database (ratings-mongodb).</span></span>
 4) <span data-ttu-id="35d4f-132">Контроллер объекта ingress, который направляет трафик HTTP/HTTPS в конечные точки в кластере Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="35d4f-132">The Ingress Controller that routes HTTP/HTTPS traffic to endpoints within the Kubernetes cluster.</span></span>

<span data-ttu-id="35d4f-133">Пример приложения используется для иллюстрации архитектуры приложения.</span><span class="sxs-lookup"><span data-stu-id="35d4f-133">The sample application is used to illustrate the application architecture.</span></span> <span data-ttu-id="35d4f-134">Все компоненты являются примерами.</span><span class="sxs-lookup"><span data-stu-id="35d4f-134">All components are examples.</span></span> <span data-ttu-id="35d4f-135">Архитектура содержит только развертывание одного приложения.</span><span class="sxs-lookup"><span data-stu-id="35d4f-135">The architecture contains only a single application deployment.</span></span> <span data-ttu-id="35d4f-136">Для достижения высокого уровня доступности (HA) мы будем запускать развертывание по крайней мере два раза в двух разных экземплярах Azure Stack Hub. Они могут выполняться в одном расположении или на двух (или больше) разных сайтах:</span><span class="sxs-lookup"><span data-stu-id="35d4f-136">To achieve high availability (HA), we'll run the deployment at least twice on two different Azure Stack Hub instances - they can run either in the same location or in two (or more) different sites:</span></span>

![Архитектура инфраструктуры](media/pattern-highly-available-kubernetes/aks-azure-architecture.png)

<span data-ttu-id="35d4f-138">Такие службы, как Реестр контейнеров Azure, Azure Monitor и другие, размещаются за пределами Azure Stack Hub в Azure или в локальной среде.</span><span class="sxs-lookup"><span data-stu-id="35d4f-138">Services like Azure Container Registry, Azure Monitor, and others, are hosted outside Azure Stack Hub in Azure or on-premises.</span></span> <span data-ttu-id="35d4f-139">Эта гибридная структура защищает решение от выхода из строя одного экземпляра Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-139">This hybrid design protects the solution against outage of a single Azure Stack Hub instance.</span></span>

## <a name="components"></a><span data-ttu-id="35d4f-140">Components</span><span class="sxs-lookup"><span data-stu-id="35d4f-140">Components</span></span>

<span data-ttu-id="35d4f-141">Общая архитектура состоит из следующих компонентов:</span><span class="sxs-lookup"><span data-stu-id="35d4f-141">The overall architecture consists of the following components:</span></span>

<span data-ttu-id="35d4f-142">**Azure Stack Hub** — это расширение Azure, которое позволяет запускать рабочие нагрузки в локальной среде, предоставляя службы Azure в центре обработки данных.</span><span class="sxs-lookup"><span data-stu-id="35d4f-142">**Azure Stack Hub** is an extension of Azure that can run workloads in an on-premises environment by providing Azure services in your datacenter.</span></span> <span data-ttu-id="35d4f-143">Дополнительные сведения об Azure Stack Hub см. в [этой статье](/azure-stack/operator/azure-stack-overview).</span><span class="sxs-lookup"><span data-stu-id="35d4f-143">Go to [Azure Stack Hub overview](/azure-stack/operator/azure-stack-overview) to learn more.</span></span>

<span data-ttu-id="35d4f-144">**Обработчик Службы Azure Kubernetes (обработчик AKS)** является подсистемой для предложения услуги управляемой среды Kubernetes, Службы Azure Kubernetes (AKS), которая доступна в Azure уже сегодня.</span><span class="sxs-lookup"><span data-stu-id="35d4f-144">**Azure Kubernetes Service Engine (AKS Engine)** is the engine behind the managed Kubernetes service offering, Azure Kubernetes Service (AKS), that is available in Azure today.</span></span> <span data-ttu-id="35d4f-145">Для Azure Stack Hub Обработчик AKS позволяет развертывать, масштабировать и обновлять полнофункциональные самоуправляемые кластеры Kubernetes, используя возможности IaaS Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-145">For Azure Stack Hub, AKS Engine allows us to deploy, scale, and upgrade fully featured, self-managed Kubernetes clusters using Azure Stack Hub's IaaS capabilities.</span></span> <span data-ttu-id="35d4f-146">Дополнительные сведения об обработчике AKS см. [на этой странице](https://github.com/Azure/aks-engine).</span><span class="sxs-lookup"><span data-stu-id="35d4f-146">Go to [AKS Engine Overview](https://github.com/Azure/aks-engine) to learn more.</span></span>

<span data-ttu-id="35d4f-147">Ознакомьтесь с разделом [Известные проблемы и ограничения](https://github.com/Azure/aks-engine/blob/master/docs/topics/azure-stack.md#known-issues-and-limitations), чтобы узнать больше о различиях между обработчиком AKS в Azure и обработчиком AKS в Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-147">Go to [Known Issues and Limitations](https://github.com/Azure/aks-engine/blob/master/docs/topics/azure-stack.md#known-issues-and-limitations) to learn more about the differences between AKS Engine on Azure and AKS Engine on Azure Stack Hub.</span></span>

<span data-ttu-id="35d4f-148">**Виртуальная сеть Azure** используется для предоставления сетевой инфраструктуры на каждой платформе Azure Stack Hub для виртуальных машин, где размещается инфраструктура кластера Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="35d4f-148">**Azure Virtual Network (VNet)** is used to provide the network infrastructure on each Azure Stack Hub for the Virtual Machines (VMs) hosting the Kubernetes cluster infrastructure.</span></span>

<span data-ttu-id="35d4f-149">**Azure Load Balancer** используется для конечной точки API Kubernetes и контроллера объекта ingress NGINX.</span><span class="sxs-lookup"><span data-stu-id="35d4f-149">**Azure Load Balancer** is used for the Kubernetes API Endpoint and the Nginx Ingress Controller.</span></span> <span data-ttu-id="35d4f-150">Подсистема балансировки нагрузки направляет внешний трафик (например, Интернет) на узлы и виртуальные машины, предлагающие определенную службу.</span><span class="sxs-lookup"><span data-stu-id="35d4f-150">The load balancer routes external (for example, Internet) traffic to nodes and VMs offering a specific service.</span></span>

<span data-ttu-id="35d4f-151">**Реестр контейнеров Azure (ACR)** используется для хранения закрытых образов Docker и диаграмм Helm, которые развертываются в кластере.</span><span class="sxs-lookup"><span data-stu-id="35d4f-151">**Azure Container Registry (ACR)** is used to store private Docker images and Helm charts, which are deployed to the cluster.</span></span> <span data-ttu-id="35d4f-152">Обработчик АКS может выполнять аутентификацию в Реестре контейнеров с помощью удостоверения Azure AD.</span><span class="sxs-lookup"><span data-stu-id="35d4f-152">AKS Engine can authenticate with the Container Registry using an Azure AD identity.</span></span> <span data-ttu-id="35d4f-153">Для Kubernetes не требуется ACR.</span><span class="sxs-lookup"><span data-stu-id="35d4f-153">Kubernetes doesn't require ACR.</span></span> <span data-ttu-id="35d4f-154">Можно использовать другие реестры контейнеров, такие как Центр Docker.</span><span class="sxs-lookup"><span data-stu-id="35d4f-154">You can use other container registries, such as Docker Hub.</span></span>

<span data-ttu-id="35d4f-155">**Azure Repos** — это набор средств управления версиями, которые можно использовать для управления кодом.</span><span class="sxs-lookup"><span data-stu-id="35d4f-155">**Azure Repos** is a set of version control tools that you can use to manage your code.</span></span> <span data-ttu-id="35d4f-156">Вы также можете использовать GitHub или другие репозитории на основе Git.</span><span class="sxs-lookup"><span data-stu-id="35d4f-156">You can also use GitHub or other git-based repositories.</span></span> <span data-ttu-id="35d4f-157">Дополнительные сведения об Azure Repos см. в [этой статье](/azure/devops/repos/get-started/what-is-repos).</span><span class="sxs-lookup"><span data-stu-id="35d4f-157">Go to [Azure Repos Overview](/azure/devops/repos/get-started/what-is-repos) to learn more.</span></span>

<span data-ttu-id="35d4f-158">Предложение **Azure Pipelines** — это часть Azure DevOps Services, которая выполняет автоматизированные сборки, тесты и развертывания.</span><span class="sxs-lookup"><span data-stu-id="35d4f-158">**Azure Pipelines** is part of Azure DevOps Services and runs automated builds, tests, and deployments.</span></span> <span data-ttu-id="35d4f-159">Вы также можете использовать сторонние решения для CI/CD, такие как Jenkins.</span><span class="sxs-lookup"><span data-stu-id="35d4f-159">You can also use third-party CI/CD solutions such as Jenkins.</span></span> <span data-ttu-id="35d4f-160">Дополнительные сведения об Azure Pipeline см. в [этой статье](/azure/devops/pipelines/get-started/what-is-azure-pipelines).</span><span class="sxs-lookup"><span data-stu-id="35d4f-160">Go to [Azure Pipeline Overview](/azure/devops/pipelines/get-started/what-is-azure-pipelines) to learn more.</span></span>

<span data-ttu-id="35d4f-161">**Azure Monitor** собирает и хранит метрики и журналы, включая метрики платформы, для служб Azure в решении и телеметрии приложений.</span><span class="sxs-lookup"><span data-stu-id="35d4f-161">**Azure Monitor** collects and stores metrics and logs, including platform metrics for the Azure services in the solution and application telemetry.</span></span> <span data-ttu-id="35d4f-162">С помощью этих данных можно отслеживать приложения, настраивать оповещения и панели мониторинга, а также анализировать первопричины сбоев.</span><span class="sxs-lookup"><span data-stu-id="35d4f-162">Use this data to monitor the application, set up alerts and dashboards, and perform root cause analysis of failures.</span></span> <span data-ttu-id="35d4f-163">Azure Monitor интегрируется с Kubernetes для сбора метрик контроллеров, узлов и контейнеров, а также журналов контейнеров и журналов главных узлов.</span><span class="sxs-lookup"><span data-stu-id="35d4f-163">Azure Monitor integrates with Kubernetes to collect metrics from controllers, nodes, and containers, as well as container logs and master node logs.</span></span> <span data-ttu-id="35d4f-164">Дополнительные сведения об Azure Monitor см. в [этой статье](/azure/azure-monitor/overview).</span><span class="sxs-lookup"><span data-stu-id="35d4f-164">Go to [Azure Monitor Overview](/azure/azure-monitor/overview) to learn more.</span></span>

<span data-ttu-id="35d4f-165">**Диспетчер трафика Azure** — это подсистема балансировки нагрузки трафика на основе DNS, которая позволяет оптимально распределять трафик между службами в разных регионах Azure или развертываниями Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-165">**Azure Traffic Manager** is a DNS-based traffic load balancer that enables you to distribute traffic optimally to services across different Azure regions or Azure Stack Hub deployments.</span></span> <span data-ttu-id="35d4f-166">Диспетчер трафика также обеспечивает высокую доступность и скорость реагирования.</span><span class="sxs-lookup"><span data-stu-id="35d4f-166">Traffic Manager also provides high availability and responsiveness.</span></span> <span data-ttu-id="35d4f-167">Конечные точки приложения должны быть доступны за пределами системы.</span><span class="sxs-lookup"><span data-stu-id="35d4f-167">The application endpoints must be accessible from the outside.</span></span> <span data-ttu-id="35d4f-168">Также доступны и другие локальные решения.</span><span class="sxs-lookup"><span data-stu-id="35d4f-168">There are other on-premises solutions available as well.</span></span>

<span data-ttu-id="35d4f-169">**Контроллер объекта ingress Kubernetes** предоставляет маршруты HTTP(S) к службам в кластере Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="35d4f-169">**Kubernetes Ingress Controller** exposes HTTP(S) routes to services in a Kubernetes cluster.</span></span> <span data-ttu-id="35d4f-170">Для этой цели можно использовать NGINX или любой подходящий контроллер объекта ingress.</span><span class="sxs-lookup"><span data-stu-id="35d4f-170">Nginx or any suitable ingress controller can be used for this purpose.</span></span>

<span data-ttu-id="35d4f-171">**Helm** — это диспетчер пакетов для развертывания Kubernetes, предоставляющий возможность упаковывать различные объекты Kubernetes, например развертывания, службы и секреты, в единую диаграмму.</span><span class="sxs-lookup"><span data-stu-id="35d4f-171">**Helm** is a package manager for Kubernetes deployment, providing a way to bundle different Kubernetes objects like Deployments, Services, Secrets, into a single "chart".</span></span> <span data-ttu-id="35d4f-172">Вы можете публиковать, развертывать и контролировать управление версиями, а также обновлять объекты диаграммы.</span><span class="sxs-lookup"><span data-stu-id="35d4f-172">You can publish, deploy, control version management, and update a chart  object.</span></span> <span data-ttu-id="35d4f-173">Реестр контейнеров Azure можно использовать в качестве репозитория для хранения упакованных диаграмм Helm.</span><span class="sxs-lookup"><span data-stu-id="35d4f-173">Azure Container Registry can be used as a repository to store packaged Helm Charts.</span></span>

## <a name="design-considerations"></a><span data-ttu-id="35d4f-174">Рекомендации по проектированию</span><span class="sxs-lookup"><span data-stu-id="35d4f-174">Design considerations</span></span>

<span data-ttu-id="35d4f-175">В рамках этого шаблона используется несколько общих рекомендаций, которые более подробно описаны в следующих разделах этой статьи:</span><span class="sxs-lookup"><span data-stu-id="35d4f-175">This pattern follows a few high-level considerations explained in more detail in the next sections of this article:</span></span>

- <span data-ttu-id="35d4f-176">Приложение использует собственные решения Kubernetes, чтобы избежать зависимости от поставщика.</span><span class="sxs-lookup"><span data-stu-id="35d4f-176">The application uses Kubernetes-native solutions, to avoid vendor lock-in.</span></span>
- <span data-ttu-id="35d4f-177">Приложение использует архитектуру микрослужб.</span><span class="sxs-lookup"><span data-stu-id="35d4f-177">The application uses a microservices architecture.</span></span>
- <span data-ttu-id="35d4f-178">Для службы Azure Stack Hub не требуется входящее подключение к Интернету, однако она позволяет создавать исходящее подключение.</span><span class="sxs-lookup"><span data-stu-id="35d4f-178">Azure Stack Hub doesn't need inbound but allows outbound Internet connectivity.</span></span>

<span data-ttu-id="35d4f-179">Эти рекомендации также применяются к реальным рабочим нагрузкам и сценариям.</span><span class="sxs-lookup"><span data-stu-id="35d4f-179">These recommended practices will apply to real-world workloads and scenarios as well.</span></span>

## <a name="scalability-considerations"></a><span data-ttu-id="35d4f-180">Вопросы масштабируемости</span><span class="sxs-lookup"><span data-stu-id="35d4f-180">Scalability considerations</span></span>

<span data-ttu-id="35d4f-181">Масштабируемость важна для обеспечения согласованного, а также надежного и эффективного доступа к приложению.</span><span class="sxs-lookup"><span data-stu-id="35d4f-181">Scalability is important to provide users consistent, reliable, and well-performing access to the application.</span></span>

<span data-ttu-id="35d4f-182">Пример сценария охватывает масштабируемость на нескольких уровнях стека приложений.</span><span class="sxs-lookup"><span data-stu-id="35d4f-182">The sample scenario covers scalability on multiple layers of the application stack.</span></span> <span data-ttu-id="35d4f-183">Ниже приведен общий обзор различных уровней:</span><span class="sxs-lookup"><span data-stu-id="35d4f-183">Here's a high-level overview of the different layers:</span></span>

| <span data-ttu-id="35d4f-184">Уровень архитектуры</span><span class="sxs-lookup"><span data-stu-id="35d4f-184">Architecture level</span></span> | <span data-ttu-id="35d4f-185">Область применения</span><span class="sxs-lookup"><span data-stu-id="35d4f-185">Affects</span></span> | <span data-ttu-id="35d4f-186">Как это сделать?</span><span class="sxs-lookup"><span data-stu-id="35d4f-186">How?</span></span> |
| --- | --- | ---
| <span data-ttu-id="35d4f-187">Приложение</span><span class="sxs-lookup"><span data-stu-id="35d4f-187">Application</span></span> | <span data-ttu-id="35d4f-188">Приложение</span><span class="sxs-lookup"><span data-stu-id="35d4f-188">Application</span></span> | <span data-ttu-id="35d4f-189">Горизонтальное масштабирование на основе числа модулей pod, реплик и экземпляров контейнеров\*</span><span class="sxs-lookup"><span data-stu-id="35d4f-189">Horizontal scaling based on the number of Pods/Replicas/Container Instances\*</span></span> |
| <span data-ttu-id="35d4f-190">Кластер</span><span class="sxs-lookup"><span data-stu-id="35d4f-190">Cluster</span></span> | <span data-ttu-id="35d4f-191">Кластер Kubernetes</span><span class="sxs-lookup"><span data-stu-id="35d4f-191">Kubernetes cluster</span></span> | <span data-ttu-id="35d4f-192">Количество узлов (от 1 до 50), размеры SKU виртуальной машины и пулы узлов (обработчик AKS в Azure Stack Hub в настоящее время поддерживает только один пул узлов); использование команды масштабирования обработчика AKS (вручную)</span><span class="sxs-lookup"><span data-stu-id="35d4f-192">Number of Nodes (between 1 and 50), VM-SKU-sizes, and Node Pools (AKS Engine on Azure Stack Hub currently supports only a single node pool); using AKS Engine's scale command (manual)</span></span> |
| <span data-ttu-id="35d4f-193">Инфраструктура</span><span class="sxs-lookup"><span data-stu-id="35d4f-193">Infrastructure</span></span> | <span data-ttu-id="35d4f-194">Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="35d4f-194">Azure Stack Hub</span></span> | <span data-ttu-id="35d4f-195">Число узлов, емкость и единицы масштабирования в развертывании Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="35d4f-195">Number of nodes, capacity, and scale units within an Azure Stack Hub deployment</span></span> |

<span data-ttu-id="35d4f-196">\* Использование средства горизонтального масштабирования (HPA) Kubernetes; автоматическое масштабирование на основе метрик или вертикальное масштабирование путем изменения размера экземпляров контейнера (ЦП/память).</span><span class="sxs-lookup"><span data-stu-id="35d4f-196">\* Using Kubernetes' Horizontal Pod Autoscaler (HPA); automated metric-based scaling or vertical scaling by sizing the container instances (cpu/memory).</span></span>

<span data-ttu-id="35d4f-197">**Azure Stack Hub (уровень инфраструктуры)**</span><span class="sxs-lookup"><span data-stu-id="35d4f-197">**Azure Stack Hub (infrastructure level)**</span></span>

<span data-ttu-id="35d4f-198">Инфраструктура Azure Stack Hub является основой этой реализации, так как Azure Stack Hub работает на физическом оборудовании в центре обработки данных.</span><span class="sxs-lookup"><span data-stu-id="35d4f-198">The Azure Stack Hub infrastructure is the foundation of this implementation, because Azure Stack Hub runs on physical hardware in a datacenter.</span></span> <span data-ttu-id="35d4f-199">При выборе оборудования центра необходимо настроить параметры ЦП, плотность памяти, конфигурацию хранилища и количество серверов.</span><span class="sxs-lookup"><span data-stu-id="35d4f-199">When selecting your Hub hardware, you need to make choices for CPU, memory density, storage configuration, and number of servers.</span></span> <span data-ttu-id="35d4f-200">Дополнительные сведения о масштабируемости Azure Stack Hub см. в следующих статьях:</span><span class="sxs-lookup"><span data-stu-id="35d4f-200">To learn more about Azure Stack Hub's scalability, check out the following resources:</span></span>

- [<span data-ttu-id="35d4f-201">Общие сведения о планировании ресурсов для Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="35d4f-201">Capacity planning for Azure Stack Hub overview</span></span>](/azure-stack/operator/azure-stack-capacity-planning-overview)
- [<span data-ttu-id="35d4f-202">Добавление дополнительных узлов единиц масштабирования в Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="35d4f-202">Add additional scale unit nodes in Azure Stack Hub</span></span>](/azure-stack/operator/azure-stack-add-scale-node)

<span data-ttu-id="35d4f-203">**Кластер Kubernetes (уровень кластера)**</span><span class="sxs-lookup"><span data-stu-id="35d4f-203">**Kubernetes cluster (cluster level)**</span></span>

<span data-ttu-id="35d4f-204">Сам кластер Kubernetes основан на компонентах IaaS Azure (Stack), включая вычислительные ресурсы, хранилище и сетевые ресурсы.</span><span class="sxs-lookup"><span data-stu-id="35d4f-204">The Kubernetes cluster itself consists of, and is built on top of Azure (Stack) IaaS components including compute, storage, and network resources.</span></span> <span data-ttu-id="35d4f-205">Для решений Kubernetes используются главные и рабочие узлы, которые развертываются как виртуальные машины в Azure (и Azure Stack Hub).</span><span class="sxs-lookup"><span data-stu-id="35d4f-205">Kubernetes solutions involve master and worker nodes, which are deployed as VMs in Azure (and Azure Stack Hub).</span></span>

- <span data-ttu-id="35d4f-206">[Узлы уровня управления](/azure/aks/concepts-clusters-workloads#control-plane) (главные) предоставляют основные службы Kubernetes и оркестрируют рабочие нагрузки приложения.</span><span class="sxs-lookup"><span data-stu-id="35d4f-206">[Control plane nodes](/azure/aks/concepts-clusters-workloads#control-plane) (master) provide the core Kubernetes services and orchestration of application workloads.</span></span>
- <span data-ttu-id="35d4f-207">[Рабочие узлы](/azure/aks/concepts-clusters-workloads#nodes-and-node-pools) (рабочая роль) выполняют рабочие нагрузки приложения.</span><span class="sxs-lookup"><span data-stu-id="35d4f-207">[Worker nodes](/azure/aks/concepts-clusters-workloads#nodes-and-node-pools) (worker) run your application workloads.</span></span>

<span data-ttu-id="35d4f-208">При выборе размеров виртуальных машин для первоначального развертывания необходимо учитывать следующее:</span><span class="sxs-lookup"><span data-stu-id="35d4f-208">When selecting VM sizes for the initial deployment, there are several considerations:</span></span>  

- <span data-ttu-id="35d4f-209">**Затраты**. При планировании рабочих узлов учитывайте общую стоимость каждой виртуальной машины.</span><span class="sxs-lookup"><span data-stu-id="35d4f-209">**Cost** - When planning your worker nodes, keep in mind the overall cost per VM you'll incur.</span></span> <span data-ttu-id="35d4f-210">Например, если для рабочих нагрузок приложения требуются ограниченные ресурсы, следует запланировать развертывание виртуальных машин меньшего размера.</span><span class="sxs-lookup"><span data-stu-id="35d4f-210">For example, if your application workloads require limited resources, you should plan to deploy smaller sized VMs.</span></span> <span data-ttu-id="35d4f-211">Azure Stack Hub, как и Azure, обычно оплачивается по мере использования, поэтому для оптимизации затрат на потребление важно правильно изменить размер виртуальных машин для ролей Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="35d4f-211">Azure Stack Hub, like Azure, is normally billed on a consumption basis, so appropriately sizing the VMs for Kubernetes roles is crucial to optimizing consumption costs.</span></span> 

- <span data-ttu-id="35d4f-212">**Масштабируемость**. Масштабируемость кластера достигается с помощью свертывания и развертывания соответствующего числа основных и рабочих узлов, а также за счет добавления дополнительных пулов узлов (сейчас эта возможность недоступна в Azure Stack Hub).</span><span class="sxs-lookup"><span data-stu-id="35d4f-212">**Scalability** - Scalability of the cluster is achieved by scaling in and out the number of master and worker nodes, or by adding additional node pools (not available on Azure Stack Hub today).</span></span> <span data-ttu-id="35d4f-213">Масштабирование кластера может выполняться на основе данных о производительности, собранных с помощью аналитики для контейнеров (Azure Monitor и Log Analytics).</span><span class="sxs-lookup"><span data-stu-id="35d4f-213">Scaling the cluster can be done based on performance data, collected using Container Insights (Azure Monitor + Log Analytics).</span></span> 

    <span data-ttu-id="35d4f-214">Если для приложения требуется больше (или меньше) ресурсов, можно горизонтально увеличить масштаб (или уменьшить) текущих узлов (от 1 до 50 узлов).</span><span class="sxs-lookup"><span data-stu-id="35d4f-214">If your application needs more (or fewer) resources, you can scale out (or in) your current nodes horizontally (between 1 and 50 nodes).</span></span> <span data-ttu-id="35d4f-215">Если требуется более 50 узлов, можно создать дополнительный кластер в отдельной подписке.</span><span class="sxs-lookup"><span data-stu-id="35d4f-215">If you need more than 50 nodes, you can create an additional cluster in a separate subscription.</span></span> <span data-ttu-id="35d4f-216">Невозможно вертикально увеличить масштаб фактических виртуальных машин до размера другой виртуальной машины без повторного развертывания кластера.</span><span class="sxs-lookup"><span data-stu-id="35d4f-216">You can't scale up the actual VMs vertically to another VM size without redeploying the cluster.</span></span>

    <span data-ttu-id="35d4f-217">Масштабирование выполняется вручную с помощью вспомогательной виртуальной машины обработчика AKS, которая использовалась для первоначального развертывания кластера Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="35d4f-217">Scaling is done manually using the AKS Engine helper VM that was used to deploy the Kubernetes cluster initially.</span></span> <span data-ttu-id="35d4f-218">Дополнительные сведения см. в статье [Масштабирование кластеров Kubernetes](https://github.com/Azure/aks-engine/blob/master/docs/topics/scale.md).</span><span class="sxs-lookup"><span data-stu-id="35d4f-218">For more information, see [Scaling Kubernetes clusters](https://github.com/Azure/aks-engine/blob/master/docs/topics/scale.md)</span></span>

- <span data-ttu-id="35d4f-219">**Квоты**. Учитывайте [квоты](/azure-stack/operator/azure-stack-quota-types), настроенные при планировании развертывания AKS в Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-219">**Quotas** - Consider the [quotas](/azure-stack/operator/azure-stack-quota-types) you've configured when planning out an AKS deployment on your Azure Stack Hub.</span></span> <span data-ttu-id="35d4f-220">Убедитесь, что каждая [подписка](/azure-stack/operator/service-plan-offer-subscription-overview) имеет соответствующие настроенные планы и квоты.</span><span class="sxs-lookup"><span data-stu-id="35d4f-220">Make sure each [subscription](/azure-stack/operator/service-plan-offer-subscription-overview) has the proper plans and the quotas configured.</span></span> <span data-ttu-id="35d4f-221">Подписка должна содержать объем вычислительных ресурсов, хранилища и других служб, необходимый для горизонтального увеличения масштаба кластеров.</span><span class="sxs-lookup"><span data-stu-id="35d4f-221">The subscription will need to accommodate the amount of compute, storage, and other services needed for your clusters as they scale out.</span></span>

- <span data-ttu-id="35d4f-222">**Рабочие нагрузки приложений**. Дополнительные сведения см. в разделе об [основных понятиях кластеров и рабочих нагрузок](/azure/aks/concepts-clusters-workloads#nodes-and-node-pools) в статье "Ключевые концепции Kubernetes для службы Azure Kubernetes".</span><span class="sxs-lookup"><span data-stu-id="35d4f-222">**Application workloads** - Refer to the [Clusters and workloads concepts](/azure/aks/concepts-clusters-workloads#nodes-and-node-pools) in the Kubernetes core concepts for Azure Kubernetes Service document.</span></span> <span data-ttu-id="35d4f-223">Эта статья поможет вам определить соответствующий размер виртуальной машины в зависимости от необходимого для приложения объема вычислительных ресурсов и памяти.</span><span class="sxs-lookup"><span data-stu-id="35d4f-223">This article will help you scope the proper VM size based on the compute and memory needs of your application.</span></span>  

<span data-ttu-id="35d4f-224">**Приложение (уровень приложения)**</span><span class="sxs-lookup"><span data-stu-id="35d4f-224">**Application (application level)**</span></span>

<span data-ttu-id="35d4f-225">На уровне приложения используется [средство горизонтального автомасштабирования pod (HPA)](https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/) Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="35d4f-225">On the application layer, we use Kubernetes [Horizontal Pod Autoscaler (HPA)](https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/).</span></span> <span data-ttu-id="35d4f-226">Средство HPA может увеличить или уменьшить количество реплик (экземпляров pod/контейнеров) в нашем развертывании на основе различных метрик (например, использование ЦП).</span><span class="sxs-lookup"><span data-stu-id="35d4f-226">HPA can increase or decrease the number of Replicas (Pod/Container Instances) in our deployment based on different metrics (like CPU utilization).</span></span>

<span data-ttu-id="35d4f-227">Другой вариант — выполнить вертикальное масштабирование экземпляров контейнеров.</span><span class="sxs-lookup"><span data-stu-id="35d4f-227">Another option is to scale container instances vertically.</span></span> <span data-ttu-id="35d4f-228">Это можно сделать, изменив требуемый объем ресурсов ЦП и памяти для конкретного развертывания.</span><span class="sxs-lookup"><span data-stu-id="35d4f-228">This can be accomplished by changing the amount of CPU and Memory requested and available for a specific deployment.</span></span> <span data-ttu-id="35d4f-229">Дополнительные сведения см. в статье [Управление ресурсами для контейнеров](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/) на сайте kubernetes.io.</span><span class="sxs-lookup"><span data-stu-id="35d4f-229">See [Managing Resources for Containers](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/) on kubernetes.io to learn more.</span></span>

## <a name="networking-and-connectivity-considerations"></a><span data-ttu-id="35d4f-230">Рекомендации по сети и подключению</span><span class="sxs-lookup"><span data-stu-id="35d4f-230">Networking and connectivity considerations</span></span>

<span data-ttu-id="35d4f-231">Сеть и подключение также влияют на три уровня, упомянутые ранее при изучении Kubernetes в Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-231">Networking and connectivity also affect the three layers mentioned previously for Kubernetes on Azure Stack Hub.</span></span> <span data-ttu-id="35d4f-232">В следующей таблице показаны уровни и службы, которые они содержат:</span><span class="sxs-lookup"><span data-stu-id="35d4f-232">The following table shows the layers and which services they contain:</span></span>

| <span data-ttu-id="35d4f-233">Уровень</span><span class="sxs-lookup"><span data-stu-id="35d4f-233">Layer</span></span> | <span data-ttu-id="35d4f-234">Область применения</span><span class="sxs-lookup"><span data-stu-id="35d4f-234">Affects</span></span> | <span data-ttu-id="35d4f-235">Что?</span><span class="sxs-lookup"><span data-stu-id="35d4f-235">What?</span></span> |
| --- | --- | ---
| <span data-ttu-id="35d4f-236">Приложение</span><span class="sxs-lookup"><span data-stu-id="35d4f-236">Application</span></span> | <span data-ttu-id="35d4f-237">Приложение</span><span class="sxs-lookup"><span data-stu-id="35d4f-237">Application</span></span> | <span data-ttu-id="35d4f-238">Как осуществляется доступ к приложению?</span><span class="sxs-lookup"><span data-stu-id="35d4f-238">How is the application accessible?</span></span> <span data-ttu-id="35d4f-239">Будет ли оно доступно через Интернет.</span><span class="sxs-lookup"><span data-stu-id="35d4f-239">Will it be exposed to the Internet?</span></span> |
| <span data-ttu-id="35d4f-240">Кластер</span><span class="sxs-lookup"><span data-stu-id="35d4f-240">Cluster</span></span> | <span data-ttu-id="35d4f-241">Кластер Kubernetes</span><span class="sxs-lookup"><span data-stu-id="35d4f-241">Kubernetes cluster</span></span> | <span data-ttu-id="35d4f-242">API Kubernetes, виртуальная машина обработчика AKS, извлечение образов контейнеров (исходящий трафик), отправка данных мониторинга и телеметрии (исходящий трафик).</span><span class="sxs-lookup"><span data-stu-id="35d4f-242">Kubernetes API, AKS Engine VM, Pulling container images (egress), Sending monitoring data and telemetry (egress)</span></span> |
| <span data-ttu-id="35d4f-243">Инфраструктура</span><span class="sxs-lookup"><span data-stu-id="35d4f-243">Infrastructure</span></span> | <span data-ttu-id="35d4f-244">Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="35d4f-244">Azure Stack Hub</span></span> | <span data-ttu-id="35d4f-245">Доступность конечных точек управления Azure Stack Hub, таких как конечные точки портала и Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="35d4f-245">Accessibility of the Azure Stack Hub management endpoints like the portal and Azure Resource Manager endpoints.</span></span> |

<span data-ttu-id="35d4f-246">**Приложение**</span><span class="sxs-lookup"><span data-stu-id="35d4f-246">**Application**</span></span>

<span data-ttu-id="35d4f-247">Для уровня приложения наиболее важным моментом является доступность приложения через Интернет.</span><span class="sxs-lookup"><span data-stu-id="35d4f-247">For the application layer, the most important consideration is whether the application is exposed and accessible from the Internet.</span></span> <span data-ttu-id="35d4f-248">В Kubernetes доступность через Интернет означает, что вы можете получить доступ к развертыванию или pod с помощью службы Kubernetes или контроллера объекта ingress.</span><span class="sxs-lookup"><span data-stu-id="35d4f-248">From a Kubernetes perspective, Internet accessibility means exposing a deployment or pod using a Kubernetes Service or an Ingress Controller.</span></span>

> [!NOTE]
> <span data-ttu-id="35d4f-249">Мы рекомендуем использовать контроллеры объекта ingress для предоставления доступа к службам Kubernetes, так как число общедоступных интерфейсных IP-адресов в Azure Stack Hub ограничено пятью.</span><span class="sxs-lookup"><span data-stu-id="35d4f-249">We recommend the use of Ingress controllers to expose Kubernetes Services as the number of Frontend public IPs on Azure Stack Hub is limited to 5.</span></span> <span data-ttu-id="35d4f-250">Эта схема также ограничивает количество служб Kubernetes (с типом LoadBalancer) до 5, что будет слишком низким ограничением для многих развертываний.</span><span class="sxs-lookup"><span data-stu-id="35d4f-250">This design also limits the number of Kubernetes Services (with the type LoadBalancer) to 5, which will be too small for many deployments.</span></span> <span data-ttu-id="35d4f-251">Дополнительные сведения см. в документации по [обработчику AKS](https://github.com/Azure/aks-engine/blob/master/docs/topics/azure-stack.md#limited-number-of-frontend-public-ips).</span><span class="sxs-lookup"><span data-stu-id="35d4f-251">Go to the [AKS Engine documentation](https://github.com/Azure/aks-engine/blob/master/docs/topics/azure-stack.md#limited-number-of-frontend-public-ips) to learn more.</span></span>

<span data-ttu-id="35d4f-252">Наличие доступа к приложению с помощью общедоступного IP-адреса через Load Balancer или контроллер объекта ingress не обязательно означает, что приложение теперь доступно через Интернет.</span><span class="sxs-lookup"><span data-stu-id="35d4f-252">Exposing an application using a public IP via a Load Balancer or an Ingress Controller doesn't nessecarily mean that the application is now accessible via the Internet.</span></span> <span data-ttu-id="35d4f-253">Azure Stack Hub может иметь общедоступный IP-адрес, который виден только в локальной интрасети (не все общедоступные IP-адреса действительно доступны через Интернет).</span><span class="sxs-lookup"><span data-stu-id="35d4f-253">It's possible for Azure Stack Hub to have a public IP address that is only visible on the local intranet - not all public IPs are truly Internet-facing.</span></span>

<span data-ttu-id="35d4f-254">В рамках предыдущего блока учитывается входящий трафик в приложение.</span><span class="sxs-lookup"><span data-stu-id="35d4f-254">The previous block considers ingress traffic to the application.</span></span> <span data-ttu-id="35d4f-255">Еще один момент, который необходимо учитывать для успешного развертывания Kubernetes, — это исходящий трафик.</span><span class="sxs-lookup"><span data-stu-id="35d4f-255">Another topic that must be considered for a successful Kubernetes deployment is outbound/egress traffic.</span></span> <span data-ttu-id="35d4f-256">Ниже приведены несколько вариантов использования, требующих исходящий трафик:</span><span class="sxs-lookup"><span data-stu-id="35d4f-256">Here are a few use cases that require egress traffic:</span></span>

- <span data-ttu-id="35d4f-257">извлечение образов контейнеров, хранящихся в DockerHub или Реестре контейнеров Azure;</span><span class="sxs-lookup"><span data-stu-id="35d4f-257">Pulling Container Images stored on DockerHub or Azure Container Registry</span></span>
- <span data-ttu-id="35d4f-258">извлечение диаграмм Helm;</span><span class="sxs-lookup"><span data-stu-id="35d4f-258">Retrieving Helm Charts</span></span>
- <span data-ttu-id="35d4f-259">отправка данных Application Insights (или других данных мониторинга).</span><span class="sxs-lookup"><span data-stu-id="35d4f-259">Emitting Application Insights data (or other monitoring data)</span></span>

<span data-ttu-id="35d4f-260">В некоторых корпоративных средах может потребоваться использование _прозрачных_ или _непрозрачных_ прокси-серверов.</span><span class="sxs-lookup"><span data-stu-id="35d4f-260">Some enterprise environments might require the use of _transparent_ or _non-transparent_ proxy servers.</span></span> <span data-ttu-id="35d4f-261">Для этих серверов требуется определенная конфигурация различных компонентов нашего кластера.</span><span class="sxs-lookup"><span data-stu-id="35d4f-261">These servers require specific configuration on various components of our cluster.</span></span> <span data-ttu-id="35d4f-262">Документация по обработчику AKS содержит различные сведения о том, как разместить сетевые прокси-серверы.</span><span class="sxs-lookup"><span data-stu-id="35d4f-262">The AKS Engine documentation contains various details on how to accommodate network proxies.</span></span> <span data-ttu-id="35d4f-263">Дополнительные сведения см. в статье [Обработчик AKS и прокси-сервера](https://github.com/Azure/aks-engine/blob/master/docs/topics/proxy-servers.md).</span><span class="sxs-lookup"><span data-stu-id="35d4f-263">For more details, see [AKS Engine and proxy servers](https://github.com/Azure/aks-engine/blob/master/docs/topics/proxy-servers.md)</span></span>

<span data-ttu-id="35d4f-264">Наконец, трафик между кластерами должен передаваться между экземплярами Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-264">Lastly, cross-cluster traffic must flow between Azure Stack Hub instances.</span></span> <span data-ttu-id="35d4f-265">Пример развертывания состоит из отдельных кластеров Kubernetes, работающих в отдельных экземплярах Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-265">The sample deployment consists of individual Kubernetes clusters running on individual Azure Stack Hub instances.</span></span> <span data-ttu-id="35d4f-266">Трафик между ними (например, трафик репликации между двумя базами данных) является "внешним трафиком".</span><span class="sxs-lookup"><span data-stu-id="35d4f-266">Traffic between them, such as the replication traffic between two databases, is "external traffic".</span></span> <span data-ttu-id="35d4f-267">Внешний трафик должен проходить через VPN типа "сеть — сеть" или общедоступные IP-адреса Azure Stack Hub для подключения Kubernetes к двум экземплярам Azure Stack Hub:</span><span class="sxs-lookup"><span data-stu-id="35d4f-267">External traffic must be routed through either a Site-to-Site VPN or Azure Stack Hub Public IP addresses to connect Kubernetes on two Azure Stack Hub instances:</span></span>

![Трафик между кластерами и внутри кластера](media/pattern-highly-available-kubernetes/aks-inter-and-intra-cluster-traffic.png)

<span data-ttu-id="35d4f-269">**Cluster**</span><span class="sxs-lookup"><span data-stu-id="35d4f-269">**Cluster**</span></span>  

<span data-ttu-id="35d4f-270">Кластер Kubernetes не обязательно должен быть доступен через Интернет.</span><span class="sxs-lookup"><span data-stu-id="35d4f-270">The Kubernetes cluster doesn't necessarily need to be accessible via the Internet.</span></span> <span data-ttu-id="35d4f-271">Значимая часть — это API Kubernetes, используемый для эксплуатации кластера, например с помощью `kubectl`.</span><span class="sxs-lookup"><span data-stu-id="35d4f-271">The relevant part is the Kubernetes API used to operate a cluster, for example, using `kubectl`.</span></span> <span data-ttu-id="35d4f-272">Конечная точка API Kubernetes должна быть доступна всем, кто работает с кластером или развертывает приложения и службы на базе кластера.</span><span class="sxs-lookup"><span data-stu-id="35d4f-272">The Kubernetes API endpoint must be accessible to everyone who operates the cluster or deploys applications and services on top of it.</span></span> <span data-ttu-id="35d4f-273">Эта тема более подробно рассматривается с учетом DevOps в разделе [Рекомендации по развертыванию (CI/CD)](#deployment-cicd-considerations) ниже.</span><span class="sxs-lookup"><span data-stu-id="35d4f-273">This topic is covered in more detail from a DevOps-perspective in the [Deployment (CI/CD) considerations](#deployment-cicd-considerations) section below.</span></span>

<span data-ttu-id="35d4f-274">На уровне кластера также необходимо учитывать несколько аспектов, касающихся исходящего трафика:</span><span class="sxs-lookup"><span data-stu-id="35d4f-274">On the cluster level, there are also a few considerations around egress-traffic:</span></span>

- <span data-ttu-id="35d4f-275">обновления узла (для Ubuntu);</span><span class="sxs-lookup"><span data-stu-id="35d4f-275">Node updates (for Ubuntu)</span></span>
- <span data-ttu-id="35d4f-276">данные мониторинга (отправленные в Azure LogAnalytics);</span><span class="sxs-lookup"><span data-stu-id="35d4f-276">Monitoring data (sent to Azure LogAnalytics)</span></span>
- <span data-ttu-id="35d4f-277">другие агенты, для которых требуется исходящий трафик (зависит от среды развертывания).</span><span class="sxs-lookup"><span data-stu-id="35d4f-277">Other agents requiring outbound traffic (specific to each deployer's environment)</span></span>

<span data-ttu-id="35d4f-278">Перед развертыванием кластера Kubernetes с помощью обработчика AKS спланируйте окончательную структуру сети.</span><span class="sxs-lookup"><span data-stu-id="35d4f-278">Before you deploy your Kubernetes cluster using AKS Engine, plan for the final networking design.</span></span> <span data-ttu-id="35d4f-279">Вместо создания выделенной виртуальной сети может быть более эффективно развернуть кластер в существующей сети.</span><span class="sxs-lookup"><span data-stu-id="35d4f-279">Instead of creating a dedicated Virtual Network, it may be more efficient to deploy a cluster into an existing network.</span></span> <span data-ttu-id="35d4f-280">Например, вы можете использовать существующее VPN-подключение типа "сеть — сеть", уже настроенное в среде Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-280">For example, you might leverage an existing Site-to-Site VPN connection already configured in your Azure Stack Hub environment.</span></span>

<span data-ttu-id="35d4f-281">**Инфраструктура**</span><span class="sxs-lookup"><span data-stu-id="35d4f-281">**Infrastructure**</span></span>  

<span data-ttu-id="35d4f-282">Под инфраструктурой понимается доступ к конечным точкам управления Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-282">Infrastructure refers to accessing the Azure Stack Hub management endpoints.</span></span> <span data-ttu-id="35d4f-283">К конечным точкам относятся порталы клиента и администратора, а также конечные точки администратора и клиента Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="35d4f-283">Endpoints include the tenant and admin portals, and the Azure Resource Manager admin and tenant endpoints.</span></span> <span data-ttu-id="35d4f-284">Эти конечные точки необходимы для работы Azure Stack Hub и его основных служб.</span><span class="sxs-lookup"><span data-stu-id="35d4f-284">These endpoints are required to operate Azure Stack Hub and its core services.</span></span>

## <a name="data-and-storage-considerations"></a><span data-ttu-id="35d4f-285">Рекомендации по работе с данными и хранилищем</span><span class="sxs-lookup"><span data-stu-id="35d4f-285">Data and storage considerations</span></span>

<span data-ttu-id="35d4f-286">Два экземпляра приложения будут развернуты в двух отдельных кластерах Kubernetes и двух экземплярах Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-286">Two instances of our application will be deployed, on two individual Kubernetes clusters, across two Azure Stack Hub instances.</span></span> <span data-ttu-id="35d4f-287">Для этого необходимо выполнить репликацию и синхронизацию данных между этими элементами.</span><span class="sxs-lookup"><span data-stu-id="35d4f-287">This design will require us to consider how to replicate and synchronize data between them.</span></span>

<span data-ttu-id="35d4f-288">Azure обеспечивает встроенную возможность репликации хранилища между несколькими регионами и зонами в облаке.</span><span class="sxs-lookup"><span data-stu-id="35d4f-288">With Azure, we have the built-in capability to replicate storage across multiple regions and zones within the cloud.</span></span> <span data-ttu-id="35d4f-289">В настоящее время в Azure Stack Hub нет собственных возможностей репликации хранилища между двумя разными экземплярами Azure Stack Hub. Они формируют два независимых облака без возможности управления ими в качестве набора.</span><span class="sxs-lookup"><span data-stu-id="35d4f-289">Currently with Azure Stack Hub there are no native ways to replicate storage across two different Azure Stack Hub instances - they form two independent clouds with no overarching way to manage them as a set.</span></span> <span data-ttu-id="35d4f-290">При планировании устойчивости приложений, выполняющихся в Azure Stack Hub, необходимо учитывать эту независимость во время разработки и развертывания приложения.</span><span class="sxs-lookup"><span data-stu-id="35d4f-290">Planning for resiliency of applications running across Azure Stack Hub forces you to consider this independence in your application design and deployments.</span></span>

<span data-ttu-id="35d4f-291">В большинстве случаев репликация хранилища для отказоустойчивых и высокодоступных приложений, развернутых в AKS, не потребуется.</span><span class="sxs-lookup"><span data-stu-id="35d4f-291">In most cases, storage replication won't be necessary for a resilient and highly available application deployed on AKS.</span></span> <span data-ttu-id="35d4f-292">Но при разработке приложения рекомендуется использовать независимое хранилище для каждого экземпляра Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-292">But you should consider independent storage per Azure Stack Hub instance in your application design.</span></span> <span data-ttu-id="35d4f-293">Если это создает проблему при развертывании решения в Azure Stack Hub, воспользуйтесь решением от партнеров корпорации Майкрософт, которые предоставляют вложения хранилища.</span><span class="sxs-lookup"><span data-stu-id="35d4f-293">If this design is a concern or road block to deploying the solution on Azure Stack Hub, there are possible solutions from Microsoft Partners that provide storage attachments.</span></span> <span data-ttu-id="35d4f-294">Вложения хранилища предоставляют решение для репликации хранилища в нескольких экземплярах Azure Stack Hub и в Azure.</span><span class="sxs-lookup"><span data-stu-id="35d4f-294">Storage attachments provide a storage replication solution across multiple Azure Stack Hubs and Azure.</span></span> <span data-ttu-id="35d4f-295">Дополнительные сведения см. в разделе [Решения партнеров](#partner-solutions).</span><span class="sxs-lookup"><span data-stu-id="35d4f-295">For more information, see the [Partner solutions](#partner-solutions).</span></span>

<span data-ttu-id="35d4f-296">В нашей архитектуре были рассмотрены следующие уровни:</span><span class="sxs-lookup"><span data-stu-id="35d4f-296">In our architecture, these layers were considered:</span></span>

<span data-ttu-id="35d4f-297">**Конфигурация**</span><span class="sxs-lookup"><span data-stu-id="35d4f-297">**Configuration**</span></span>

<span data-ttu-id="35d4f-298">Конфигурация включает настройку Azure Stack Hub, обработчика AKS и самого кластера Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="35d4f-298">Configuration includes the configuration of Azure Stack Hub, AKS Engine, and the Kubernetes cluster itself.</span></span> <span data-ttu-id="35d4f-299">Конфигурация должна быть максимально автоматизированной. Она должна храниться в виде инфраструктуры как кода в системе управления версиями на основе Git, такой как Azure DevOps или GitHub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-299">The configuration should be automated as much as possible, and stored as Infrastructure-as-Code in a Git-based version control system like Azure DevOps or GitHub.</span></span> <span data-ttu-id="35d4f-300">Эти параметры нельзя легко синхронизировать в нескольких развертываниях.</span><span class="sxs-lookup"><span data-stu-id="35d4f-300">These settings cannot easily be synchronized across multiple deployments.</span></span> <span data-ttu-id="35d4f-301">Поэтому рекомендуется хранить и применять конфигурацию извне, а также использовать конвейер DevOps.</span><span class="sxs-lookup"><span data-stu-id="35d4f-301">Therefore we recommend storing and applying configuration from the outside, and using DevOps pipeline.</span></span>

<span data-ttu-id="35d4f-302">**Приложение**</span><span class="sxs-lookup"><span data-stu-id="35d4f-302">**Application**</span></span>

<span data-ttu-id="35d4f-303">Приложение должно храниться в репозитории на основе Git.</span><span class="sxs-lookup"><span data-stu-id="35d4f-303">The application should be stored in a Git-based repository.</span></span> <span data-ttu-id="35d4f-304">При новом развертывании, изменении приложения или аварийном восстановлении развертывание приложения можно легко выполнить с помощью Azure Pipelines.</span><span class="sxs-lookup"><span data-stu-id="35d4f-304">Whenever there's a new deployment, changes to the application, or disaster recovery, it can be easily deployed using Azure Pipelines.</span></span>

<span data-ttu-id="35d4f-305">**Данные**</span><span class="sxs-lookup"><span data-stu-id="35d4f-305">**Data**</span></span>

<span data-ttu-id="35d4f-306">Данные являются наиболее важным аспектом в большинстве приложений.</span><span class="sxs-lookup"><span data-stu-id="35d4f-306">Data is the most important consideration in most application designs.</span></span> <span data-ttu-id="35d4f-307">Данные приложения должны оставаться синхронизированными между разными экземплярами приложения.</span><span class="sxs-lookup"><span data-stu-id="35d4f-307">Application data must stay in sync between the different instances of the application.</span></span> <span data-ttu-id="35d4f-308">Также необходимо иметь стратегию резервного копирования и аварийного восстановления в случае сбоя данных.</span><span class="sxs-lookup"><span data-stu-id="35d4f-308">Data also needs a backup and disaster recovery strategy if there's an outage.</span></span>

<span data-ttu-id="35d4f-309">Создание этой структуры сильно зависит от выбора технологии.</span><span class="sxs-lookup"><span data-stu-id="35d4f-309">Achieving this design depends heavily on technology choices.</span></span> <span data-ttu-id="35d4f-310">Ниже приведены некоторые примеры решений для реализации базы данных с высоким уровнем доступности в Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-310">Here are some solution examples for implementing a database in a highly available fashion on Azure Stack Hub:</span></span>

- [<span data-ttu-id="35d4f-311">Развертывание группы доступности SQL Server 2016 в Azure и Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="35d4f-311">Deploy a SQL Server 2016 availability group to Azure and Azure Stack Hub</span></span>](/azure-stack/hybrid/solution-deployment-guide-sql-ha)
- [<span data-ttu-id="35d4f-312">Развертывание высокодоступного решения MongoDB в Azure и Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="35d4f-312">Deploy a highly available MongoDB solution to Azure and Azure Stack Hub</span></span>](/azure-stack/hybrid/solution-deployment-guide-mongodb-ha)

<span data-ttu-id="35d4f-313">При работе с данными в нескольких расположениях следует учитывать еще больше моментов в отношении обеспечения высокой доступности и отказоустойчивости решения.</span><span class="sxs-lookup"><span data-stu-id="35d4f-313">Considerations when working with data across multiple locations is an even more complex consideration for a highly available and resilient solution.</span></span> <span data-ttu-id="35d4f-314">Необходимо учесть следующие моменты.</span><span class="sxs-lookup"><span data-stu-id="35d4f-314">Consider:</span></span>

- <span data-ttu-id="35d4f-315">Задержка и сетевое подключение между концентраторами Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-315">Latency and network connectivity between Azure Stack Hubs.</span></span>
- <span data-ttu-id="35d4f-316">Доступность удостоверений для служб и разрешений.</span><span class="sxs-lookup"><span data-stu-id="35d4f-316">Availability of identities for services and permissions.</span></span> <span data-ttu-id="35d4f-317">Каждый экземпляр Azure Stack Hub интегрируется с внешним каталогом.</span><span class="sxs-lookup"><span data-stu-id="35d4f-317">Each Azure Stack Hub instance integrates with an external directory.</span></span> <span data-ttu-id="35d4f-318">Во время развертывания вы используете либо Azure Active Directory (Azure AD), либо службы федерации Active Directory (AD FS).</span><span class="sxs-lookup"><span data-stu-id="35d4f-318">During deployment, you choose to use either Azure Active Directory (Azure AD) or Active Directory Federation Services (ADFS).</span></span> <span data-ttu-id="35d4f-319">Таким образом, существует возможность использовать единый идентификатор, который может взаимодействовать с несколькими независимыми экземплярами Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-319">As such, there's potential to use a single identity that can interact with multiple independent Azure Stack Hub instances.</span></span>

## <a name="business-continuity-and-disaster-recovery"></a><span data-ttu-id="35d4f-320">Непрерывность бизнес-процессов и аварийное восстановление</span><span class="sxs-lookup"><span data-stu-id="35d4f-320">Business continuity and disaster recovery</span></span>

<span data-ttu-id="35d4f-321">Непрерывность бизнес-процессов и аварийное восстановление (BCDR) — это важный аспект как в Azure Stack Hub, так и в Azure.</span><span class="sxs-lookup"><span data-stu-id="35d4f-321">Business continuity and disaster recovery (BCDR) is an important topic in both Azure Stack Hub and Azure.</span></span> <span data-ttu-id="35d4f-322">Основное отличие заключается в том, что в Azure Stack Hub оператор должен управлять всем процессом BCDR.</span><span class="sxs-lookup"><span data-stu-id="35d4f-322">The main difference is that in Azure Stack Hub, the operator must manage the whole BCDR process.</span></span> <span data-ttu-id="35d4f-323">В Azure элементы BCDR автоматически управляются корпорацией Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="35d4f-323">In Azure, parts of BCDR are automatically managed by Microsoft.</span></span>

<span data-ttu-id="35d4f-324">BCDR влияет на те же области, которые упоминались в предыдущем разделе [рекомендаций по работе с данными и хранилищем](#data-and-storage-considerations):</span><span class="sxs-lookup"><span data-stu-id="35d4f-324">BCDR affects the same areas mentioned in the previous section [Data and storage considerations](#data-and-storage-considerations):</span></span>

- <span data-ttu-id="35d4f-325">инфраструктура и конфигурация;</span><span class="sxs-lookup"><span data-stu-id="35d4f-325">Infrastructure / Configuration</span></span>
- <span data-ttu-id="35d4f-326">доступность приложения;</span><span class="sxs-lookup"><span data-stu-id="35d4f-326">Application Availability</span></span>
- <span data-ttu-id="35d4f-327">Данные приложений</span><span class="sxs-lookup"><span data-stu-id="35d4f-327">Application Data</span></span>

<span data-ttu-id="35d4f-328">Как упоминалось в предыдущем разделе, эти области обрабатывает оператор Azure Stack Hub. Они могут меняться в зависимости от организаций.</span><span class="sxs-lookup"><span data-stu-id="35d4f-328">And as mentioned in the previous section, these areas are the responsibility of the Azure Stack Hub operator and can vary between organizations.</span></span> <span data-ttu-id="35d4f-329">Планируйте операции BCDR в соответствии с доступными инструментами и процессами.</span><span class="sxs-lookup"><span data-stu-id="35d4f-329">Plan BCDR according to your available tools and processes.</span></span>

<span data-ttu-id="35d4f-330">**Инфраструктура и конфигурация**</span><span class="sxs-lookup"><span data-stu-id="35d4f-330">**Infrastructure and configuration**</span></span>

<span data-ttu-id="35d4f-331">В этом разделе описана физическая и логическая инфраструктура, а также конфигурация Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-331">This section covers the physical and logical infrastructure and the configuration of Azure Stack Hub.</span></span> <span data-ttu-id="35d4f-332">Он охватывает действия в пространствах администратора и клиента.</span><span class="sxs-lookup"><span data-stu-id="35d4f-332">It covers actions in the admin and the tenant spaces.</span></span>

<span data-ttu-id="35d4f-333">Оператор Azure Stack Hub (или администратор) обслуживает экземпляры Azure Stack Hub,</span><span class="sxs-lookup"><span data-stu-id="35d4f-333">The Azure Stack Hub operator (or administrator) is responsible for maintenance of the Azure Stack Hub instances.</span></span> <span data-ttu-id="35d4f-334">включая такие компоненты, как сеть, хранилище, идентификатор и другие элементы, которые выходят за рамки этой статьи.</span><span class="sxs-lookup"><span data-stu-id="35d4f-334">Including components such as the network, storage, identity, and other topics that are outside the scope of this article.</span></span> <span data-ttu-id="35d4f-335">Дополнительные сведения о конкретных операциях Azure Stack Hub см. в следующих статьях:</span><span class="sxs-lookup"><span data-stu-id="35d4f-335">To learn more about the specifics of Azure Stack Hub operations, see the following resources:</span></span>

- [<span data-ttu-id="35d4f-336">Восстановление данных в Azure Stack Hub с помощью службы "Резервное копирование инфраструктуры"</span><span class="sxs-lookup"><span data-stu-id="35d4f-336">Recover data in Azure Stack Hub with the Infrastructure Backup Service</span></span>](/azure-stack/operator/azure-stack-backup-infrastructure-backup)
- [<span data-ttu-id="35d4f-337">Включение резервного копирования для Azure Stack Hub на портале администрирования</span><span class="sxs-lookup"><span data-stu-id="35d4f-337">Enable backup for Azure Stack Hub from the administrator portal</span></span>](/azure-stack/operator/azure-stack-backup-enable-backup-console)
- [<span data-ttu-id="35d4f-338">Восстановление после катастрофической потери данных</span><span class="sxs-lookup"><span data-stu-id="35d4f-338">Recover from catastrophic data loss</span></span>](/azure-stack/operator/azure-stack-backup-recover-data)
- [<span data-ttu-id="35d4f-339">Рекомендации по службе резервного копирования инфраструктуры</span><span class="sxs-lookup"><span data-stu-id="35d4f-339">Infrastructure Backup Service best practices</span></span>](/azure-stack/operator/azure-stack-backup-best-practices)

<span data-ttu-id="35d4f-340">Azure Stack Hub — это платформа и структура, в которых будут развернуты приложения Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="35d4f-340">Azure Stack Hub is the platform and fabric on which Kubernetes applications will be deployed.</span></span> <span data-ttu-id="35d4f-341">Владельцем приложения Kubernetes будет пользователь Azure Stack Hub, которому предоставлен доступ для развертывания инфраструктуры приложения, необходимой для решения.</span><span class="sxs-lookup"><span data-stu-id="35d4f-341">The application owner for the Kubernetes application will be a user of Azure Stack Hub, with access granted to deploy the application infrastructure needed for the solution.</span></span> <span data-ttu-id="35d4f-342">В этом случае инфраструктура приложения означает кластер Kubernetes, развернутый с помощью обработчика AKS и окружающих служб.</span><span class="sxs-lookup"><span data-stu-id="35d4f-342">Application infrastructure in this case means the Kubernetes cluster, deployed using AKS Engine, and the surrounding services.</span></span> <span data-ttu-id="35d4f-343">Эти компоненты будут развернуты в Azure Stack Hub и ограничены предложением Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-343">These components will be deployed into Azure Stack Hub, constrained by an Azure Stack Hub offer.</span></span> <span data-ttu-id="35d4f-344">Убедитесь, что предложение, принятое владельцем приложения Kubernetes, имеет достаточную емкость (выражается в квотах Azure Stack Hub) для развертывания всего решения.</span><span class="sxs-lookup"><span data-stu-id="35d4f-344">Make sure the offer accepted by the Kubernetes application owner has sufficient capacity (expressed in Azure Stack Hub quotas) to deploy the entire solution.</span></span> <span data-ttu-id="35d4f-345">Согласно рекомендациям предыдущего раздела развертывание приложения должно быть автоматизировано с помощью инфраструктуры как кода и конвейеров развертывания, таких как Azure DevOps Azure Pipelines.</span><span class="sxs-lookup"><span data-stu-id="35d4f-345">As recommended in the previous section, the application deployment should be automated using Infrastructure-as-Code and deployment pipelines like Azure DevOps Azure Pipelines.</span></span>

<span data-ttu-id="35d4f-346">Дополнительные сведения о предложениях и квотах Azure Stack Hub см. в статье [Общие сведения о службах, планах, предложениях и подписках в Azure Stack Hub](/azure-stack/operator/service-plan-offer-subscription-overview).</span><span class="sxs-lookup"><span data-stu-id="35d4f-346">For more information on Azure Stack Hub offers and quotas, see [Azure Stack Hub services, plans, offers, and subscriptions overview](/azure-stack/operator/service-plan-offer-subscription-overview)</span></span>

<span data-ttu-id="35d4f-347">Важно безопасно сохранять конфигурацию обработчика AKS, включая выходные данные.</span><span class="sxs-lookup"><span data-stu-id="35d4f-347">It's important to securely save and store the AKS Engine configuration including its outputs.</span></span> <span data-ttu-id="35d4f-348">Эти файлы содержат конфиденциальную информацию, используемую для доступа к кластеру Kubernetes, поэтому она должна быть защищена от пользователей, не являющихся администраторами.</span><span class="sxs-lookup"><span data-stu-id="35d4f-348">These files contain confidential information used to access the Kubernetes cluster, so it must be protected from being exposed to non-administrators.</span></span>

<span data-ttu-id="35d4f-349">**Доступность приложения**</span><span class="sxs-lookup"><span data-stu-id="35d4f-349">**Application availability**</span></span>

<span data-ttu-id="35d4f-350">Приложение не должно зависеть от резервных копий развернутого экземпляра.</span><span class="sxs-lookup"><span data-stu-id="35d4f-350">The application shouldn't rely on backups of a deployed instance.</span></span> <span data-ttu-id="35d4f-351">В рамках своей обычной практики повторно разверните приложение полностью, следуя шаблонам инфраструктуры как кода.</span><span class="sxs-lookup"><span data-stu-id="35d4f-351">As a standard practice, redeploy the application completely following Infrastructure-as-Code patterns.</span></span> <span data-ttu-id="35d4f-352">Например, выполните повторное развертывание с помощью Azure DevOps Azure Pipelines.</span><span class="sxs-lookup"><span data-stu-id="35d4f-352">For example, redeploy using Azure DevOps Azure Pipelines.</span></span> <span data-ttu-id="35d4f-353">Во время процедуры BCDR должно выполняться повторное развертывание приложения в том же или другом кластере Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="35d4f-353">The BCDR procedure should involve the redeployment of the application to the same or another Kubernetes cluster.</span></span>

<span data-ttu-id="35d4f-354">**Данные приложения**</span><span class="sxs-lookup"><span data-stu-id="35d4f-354">**Application data**</span></span>

<span data-ttu-id="35d4f-355">Данные приложения являются важным элементом для минимизации потери данных.</span><span class="sxs-lookup"><span data-stu-id="35d4f-355">Application data is the critical part to minimize data loss.</span></span> <span data-ttu-id="35d4f-356">В предыдущем разделе были описаны методы репликации и синхронизации данных между двумя (или более) экземплярами приложения.</span><span class="sxs-lookup"><span data-stu-id="35d4f-356">In the previous section, techniques to replicate and synchronize data between two (or more) instances of the application were described.</span></span> <span data-ttu-id="35d4f-357">В зависимости от инфраструктуры базы данных (MySQL, MongoDB, MSSQL или другие), используемой для хранения данных, можно будет выбрать различные методы доступности базы данных и резервного копирования.</span><span class="sxs-lookup"><span data-stu-id="35d4f-357">Depending on the database infrastructure (MySQL, MongoDB, MSSQL or others) used to store the data, there will be different database availability and backup techniques available to choose from.</span></span>

<span data-ttu-id="35d4f-358">Для обеспечения целостности рекомендуется использовать следующие решения:</span><span class="sxs-lookup"><span data-stu-id="35d4f-358">The recommended ways to achieve integrity are to use either:</span></span>
- <span data-ttu-id="35d4f-359">собственное решение резервного копирования для конкретной базы данных;</span><span class="sxs-lookup"><span data-stu-id="35d4f-359">A native backup solution for the specific database.</span></span>
- <span data-ttu-id="35d4f-360">решение резервного копирования, которое официально поддерживает резервное копирование и восстановление типа базы данных, используемого приложением.</span><span class="sxs-lookup"><span data-stu-id="35d4f-360">A backup solution that officially supports backup and recovery of the database type used by your application.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="35d4f-361">Не храните данные резервной копии в том же экземпляре Azure Stack Hub, где находятся данные приложения.</span><span class="sxs-lookup"><span data-stu-id="35d4f-361">Do not store your backup data on the same Azure Stack Hub instance where your application data resides.</span></span> <span data-ttu-id="35d4f-362">Полный сбой экземпляра Azure Stack Hub также поставит под угрозу ваши резервные копии.</span><span class="sxs-lookup"><span data-stu-id="35d4f-362">A complete outage of the Azure Stack Hub instance would also compromise your backups.</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="35d4f-363">Вопросы доступности</span><span class="sxs-lookup"><span data-stu-id="35d4f-363">Availability considerations</span></span>

<span data-ttu-id="35d4f-364">Служба Kubernetes в Azure Stack Hub, развернутая с помощью обработчика AKS, не является управляемой службой.</span><span class="sxs-lookup"><span data-stu-id="35d4f-364">Kubernetes on Azure Stack Hub deployed via AKS Engine isn't a managed service.</span></span> <span data-ttu-id="35d4f-365">Она предоставляет автоматическое развертывание и настройку кластера Kubernetes с помощью инфраструктуры как услуги (IaaS) Azure.</span><span class="sxs-lookup"><span data-stu-id="35d4f-365">It's an automated deployment and configuration of a Kubernetes cluster using Azure Infrastructure-as-a-Service (IaaS).</span></span> <span data-ttu-id="35d4f-366">Таким образом, обеспечивается та же доступность, что и при базовой инфраструктуре.</span><span class="sxs-lookup"><span data-stu-id="35d4f-366">As such, it provides the same availability as the underlying infrastructure.</span></span>

<span data-ttu-id="35d4f-367">Инфраструктура Azure Stack Hub уже устойчива к сбоям и предоставляет возможности, такие как группы доступности, для распространения компонентов на нескольких [доменах сбоя и обновления](/azure-stack/user/azure-stack-vm-considerations#high-availability).</span><span class="sxs-lookup"><span data-stu-id="35d4f-367">Azure Stack Hub infrastructure is already resilient to failures, and provides capabilities like Availability Sets to distribute components across multiple [fault and update domains](/azure-stack/user/azure-stack-vm-considerations#high-availability).</span></span> <span data-ttu-id="35d4f-368">Но базовая технология (отказоустойчивая кластеризация) по-прежнему приводит к некоторому времени простоя виртуальных машин на поврежденном физическом сервере в случае сбоя оборудования.</span><span class="sxs-lookup"><span data-stu-id="35d4f-368">But the underlying technology (failover clustering) still incurs some downtime for VMs on an impacted physical server, if there's a hardware failure.</span></span>

<span data-ttu-id="35d4f-369">Рекомендуется развернуть рабочий кластер Kubernetes, а также рабочую нагрузку в двух (или более) кластерах.</span><span class="sxs-lookup"><span data-stu-id="35d4f-369">It's a good practice to deploy your production Kubernetes cluster as well as the workload to two (or more) clusters.</span></span> <span data-ttu-id="35d4f-370">Эти кластеры должны размещаться в разных расположениях или центрах обработки данных и использовать такие технологии, как Диспетчер трафика Azure, для маршрутизации пользователей на основе времени отклика кластера или географического положения.</span><span class="sxs-lookup"><span data-stu-id="35d4f-370">These clusters should be hosted in different locations or datacenters, and use technologies like Azure Traffic Manager to route users based on cluster response time or based on geography.</span></span>

![Использование Диспетчера трафика для управления потоками трафика](media/pattern-highly-available-kubernetes/aks-azure-traffic-manager.png)

<span data-ttu-id="35d4f-372">Клиенты с одним кластером Kubernetes обычно подключаются по IP-адресу службы или DNS-имени конкретного приложения.</span><span class="sxs-lookup"><span data-stu-id="35d4f-372">Customers who have a single Kubernetes cluster typically connect to the service IP or DNS name of a given application.</span></span> <span data-ttu-id="35d4f-373">В развертывании с несколькими кластерами клиентам следует подключаться по DNS-имени Диспетчера трафика, которое указывает на службу или входящий трафик каждого кластер Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="35d4f-373">In a multi-cluster deployment, customers should connect to a Traffic Manager DNS name that points to the services/ingress on each Kubernetes cluster.</span></span>

![Использование Диспетчера трафика для маршрутизации в локальный кластер](media/pattern-highly-available-kubernetes/aks-azure-traffic-manager-on-premises.png)

> [!NOTE]
> <span data-ttu-id="35d4f-375">Этот шаблон также является [рекомендуемым для (управляемых) кластеров AKS в Azure](/azure/aks/operator-best-practices-multi-region#plan-for-multiregion-deployment).</span><span class="sxs-lookup"><span data-stu-id="35d4f-375">This pattern is also a [best practice for (managed) AKS clusters in Azure](/azure/aks/operator-best-practices-multi-region#plan-for-multiregion-deployment).</span></span>

<span data-ttu-id="35d4f-376">Кластер Kubernetes, развернутый через обработчик AKS, должен состоять как минимум из трех главных узлов и двух рабочих узлов.</span><span class="sxs-lookup"><span data-stu-id="35d4f-376">The Kubernetes cluster itself, deployed via AKS Engine, should consist of at least three master nodes and two worker nodes.</span></span>

## <a name="identity-and-security-considerations"></a><span data-ttu-id="35d4f-377">Идентификация и безопасность</span><span class="sxs-lookup"><span data-stu-id="35d4f-377">Identity and security considerations</span></span>

<span data-ttu-id="35d4f-378">Идентификация и безопасность являются важными элементами.</span><span class="sxs-lookup"><span data-stu-id="35d4f-378">Identity and security are important topics.</span></span> <span data-ttu-id="35d4f-379">Особенно если решение охватывает независимые экземпляры Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-379">Especially when the solution spans independent Azure Stack Hub instances.</span></span> <span data-ttu-id="35d4f-380">Kubernetes и Azure (в том числе Azure Stack Hub) имеют разные механизмы управления доступом на основе ролей (RBAC):</span><span class="sxs-lookup"><span data-stu-id="35d4f-380">Kubernetes and Azure (including Azure Stack Hub) both have distinct mechanisms for role-based access control (RBAC):</span></span>

- <span data-ttu-id="35d4f-381">Azure RBAC контролирует доступ к ресурсам в Azure (и Azure Stack Hub), включая возможность создания новых ресурсов Azure.</span><span class="sxs-lookup"><span data-stu-id="35d4f-381">Azure RBAC controls access to resources in Azure (and Azure Stack Hub), including the ability to create new Azure resources.</span></span> <span data-ttu-id="35d4f-382">Разрешения могут назначаться пользователям, группам или субъектам-службам.</span><span class="sxs-lookup"><span data-stu-id="35d4f-382">Permissions can be assigned to users, groups, or service principals.</span></span> <span data-ttu-id="35d4f-383">(Субъект-служба является удостоверением безопасности, используемым приложениями.)</span><span class="sxs-lookup"><span data-stu-id="35d4f-383">(A service principal is a security identity used by applications.)</span></span>
- <span data-ttu-id="35d4f-384">Kubernetes RBAC контролирует разрешения для API Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="35d4f-384">Kubernetes RBAC controls permissions to the Kubernetes API.</span></span> <span data-ttu-id="35d4f-385">Например, создание и перечисление модулей — это действия, которые могут быть авторизованы (или запрещены) для пользователя с помощью RBAC.</span><span class="sxs-lookup"><span data-stu-id="35d4f-385">For example, creating pods and listing pods are actions that can be authorized (or denied) to a user through RBAC.</span></span> <span data-ttu-id="35d4f-386">Чтобы назначить пользователям разрешения Kubernetes, создайте роли и привязки ролей.</span><span class="sxs-lookup"><span data-stu-id="35d4f-386">To assign Kubernetes permissions to users, you create roles and role bindings.</span></span>

<span data-ttu-id="35d4f-387">**Удостоверение Azure Stack Hub и RBAC**</span><span class="sxs-lookup"><span data-stu-id="35d4f-387">**Azure Stack Hub identity and RBAC**</span></span>

<span data-ttu-id="35d4f-388">Azure Stack Hub предоставляет два варианта поставщика удостоверений.</span><span class="sxs-lookup"><span data-stu-id="35d4f-388">Azure Stack Hub provides two identity provider choices.</span></span> <span data-ttu-id="35d4f-389">Используемый поставщик зависит от среды и от того, работает ли он в подключенной или отключенной среде:</span><span class="sxs-lookup"><span data-stu-id="35d4f-389">The provider you use depends on the environment and whether running in a connected or disconnected environment:</span></span>

- <span data-ttu-id="35d4f-390">Azure AD можно использовать только в подключенной среде.</span><span class="sxs-lookup"><span data-stu-id="35d4f-390">Azure AD - can only be used in a connected environment.</span></span>
- <span data-ttu-id="35d4f-391">ADFS для традиционного леса Active Directory можно использовать как в подключенной, так и в отключенной среде.</span><span class="sxs-lookup"><span data-stu-id="35d4f-391">ADFS to a traditional Active Directory forest - can be used in both a connected or disconnected environment.</span></span>

<span data-ttu-id="35d4f-392">Поставщик удостоверений управляет пользователями и группами, а также проверкой подлинности и авторизацией для доступа к ресурсам.</span><span class="sxs-lookup"><span data-stu-id="35d4f-392">The identity provider manages users and groups, including authentication and authorization for accessing resources.</span></span> <span data-ttu-id="35d4f-393">Доступ может быть предоставлен к ресурсам Azure Stack Hub, таким как подписки, группы ресурсов, а также отдельным ресурсам, таким как виртуальные машины или подсистемы балансировки нагрузки.</span><span class="sxs-lookup"><span data-stu-id="35d4f-393">Access can be granted to Azure Stack Hub resources like subscriptions, resource groups, and individual resources like VMs or load balancers.</span></span> <span data-ttu-id="35d4f-394">Чтобы иметь модель с устойчивым доступом, рекомендуется использовать одни и тех же группы (прямые или вложенные) для всех экземпляров Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-394">To have a consistent access model, you should consider using the same groups (either direct or nested) for all Azure Stack Hubs.</span></span> <span data-ttu-id="35d4f-395">Ниже приведен пример конфигурации.</span><span class="sxs-lookup"><span data-stu-id="35d4f-395">Here's a configuration example:</span></span>

![Вложенные группы AAD Azure Stack Hub](media/pattern-highly-available-kubernetes/azure-stack-azure-ad-nested-groups.png)

<span data-ttu-id="35d4f-397">Пример содержит выделенную группу (с использованием AAD или ADFS) для определенной цели.</span><span class="sxs-lookup"><span data-stu-id="35d4f-397">The example contains a dedicated group (using AAD or ADFS) for a specific purpose.</span></span> <span data-ttu-id="35d4f-398">Например, чтобы предоставить разрешения участника для группы ресурсов, содержащей инфраструктуру кластера Kubernetes в определенном экземпляре Azure Stack Hub (здесь — участник кластера Seattle K8).</span><span class="sxs-lookup"><span data-stu-id="35d4f-398">For example, to provide Contributor permissions for the Resource Group that contains our Kubernetes cluster infrastructure on a specific Azure Stack Hub instance (here "Seattle K8s Cluster Contributor").</span></span> <span data-ttu-id="35d4f-399">Затем эти группы вкладываются в общую группу, которая содержит подгруппы для каждого экземпляра Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-399">These groups are then nested into an overall group that contains the "subgroups" for each Azure Stack Hub.</span></span>

<span data-ttu-id="35d4f-400">Теперь для нашего примера пользователя есть разрешения участника для обеих групп ресурсов, которые содержат весь набор ресурсов инфраструктуры Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="35d4f-400">Our sample user will now have "Contributor" permissions to both Resources Groups that contain the entire set of Kubernetes infrastructure resources.</span></span> <span data-ttu-id="35d4f-401">Пользователь имеет доступ к ресурсам в обоих экземплярах Azure Stack Hub, так как экземпляры работают с одним и тем же поставщиком удостоверений.</span><span class="sxs-lookup"><span data-stu-id="35d4f-401">The user will have access to resources on both Azure Stack Hub instances, because the instances share the same identity provider.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="35d4f-402">Эти разрешения влияют только на Azure Stack Hub и на некоторые ресурсы, развернутые на его основе.</span><span class="sxs-lookup"><span data-stu-id="35d4f-402">These permissions affect only Azure Stack Hub and some of the resources deployed on top of it.</span></span> <span data-ttu-id="35d4f-403">Пользователь с таким уровнем доступа может причинить много вреда, но не может получить доступ к виртуальным машинам IaaS Kubernetes и API Kubernetes без дополнительного права доступа к развертыванию Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="35d4f-403">A user who has this level of access can do a lot of harm, but cannot access the Kubernetes IaaS VMs nor the Kubernetes API without additional access to the Kubernetes deployment.</span></span>

<span data-ttu-id="35d4f-404">**Удостоверение Kubernetes и RBAC**</span><span class="sxs-lookup"><span data-stu-id="35d4f-404">**Kubernetes identity and RBAC**</span></span>

<span data-ttu-id="35d4f-405">Кластер Kubernetes по умолчанию не использует тот же поставщик удостоверений, что и базовый экземпляр Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-405">A Kubernetes cluster, by default, doesn't use the same Identity Provider as the underlaying Azure Stack Hub.</span></span> <span data-ttu-id="35d4f-406">Виртуальные машины, на которых размещается кластер Kubernetes (главный и рабочий узлы), используют ключ SSH, указанный во время развертывания кластера.</span><span class="sxs-lookup"><span data-stu-id="35d4f-406">The VMs hosting the Kubernetes cluster, the master, and worker nodes, use the SSH Key that is specified during the deployment of the cluster.</span></span> <span data-ttu-id="35d4f-407">Этот ключ SSH необходим для подключения к этим узлам с помощью SSH.</span><span class="sxs-lookup"><span data-stu-id="35d4f-407">This SSH key is required to connect to these nodes using SSH.</span></span>

<span data-ttu-id="35d4f-408">API Kubernetes (например, при доступе с помощью `kubectl`) также защищен с помощью учетных записей служб, включая учетную запись службы администратора кластера по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="35d4f-408">The Kubernetes API (for example, accessed by using `kubectl`) is also protected by service accounts including a default "cluster admin" service account.</span></span> <span data-ttu-id="35d4f-409">Учетные данные для этой учетной записи службы изначально хранятся в файле `.kube/config` в главных узлах Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="35d4f-409">The credentials for this service account are initially stored in the `.kube/config` file on your Kubernetes master nodes.</span></span>

<span data-ttu-id="35d4f-410">**Управление секретами и учетные данные приложения**</span><span class="sxs-lookup"><span data-stu-id="35d4f-410">**Secrets management and application credentials**</span></span>

<span data-ttu-id="35d4f-411">Существует несколько вариантов хранения секретов, например строк подключения или учетных данных базы данных:</span><span class="sxs-lookup"><span data-stu-id="35d4f-411">To store secrets like connection strings or database credentials there are several choices, including:</span></span>

- <span data-ttu-id="35d4f-412">Azure Key Vault</span><span class="sxs-lookup"><span data-stu-id="35d4f-412">Azure Key Vault</span></span>
- <span data-ttu-id="35d4f-413">Секреты Kubernetes</span><span class="sxs-lookup"><span data-stu-id="35d4f-413">Kubernetes Secrets</span></span>
- <span data-ttu-id="35d4f-414">Сторонние решения, такие как хранилище HashiCorp (под управлением Kubernetes).</span><span class="sxs-lookup"><span data-stu-id="35d4f-414">3rd-Party solutions like HashiCorp Vault (running on Kubernetes)</span></span>

<span data-ttu-id="35d4f-415">Не храните секреты или учетные данные в виде открытого текста в файлах конфигурации, коде приложения или в скриптах.</span><span class="sxs-lookup"><span data-stu-id="35d4f-415">Do not store secrets or credentials in plaintext in your configuration files, application code, or within scripts.</span></span> <span data-ttu-id="35d4f-416">И не храните их в системе управления версиями.</span><span class="sxs-lookup"><span data-stu-id="35d4f-416">And do not store them in a version control system.</span></span> <span data-ttu-id="35d4f-417">Вместо этого при необходимости служба автоматизации развертывания должна получить секреты.</span><span class="sxs-lookup"><span data-stu-id="35d4f-417">Instead, the deployment automation should retrieve the secrets as needed.</span></span>

## <a name="patch-and-update"></a><span data-ttu-id="35d4f-418">Исправления и обновления</span><span class="sxs-lookup"><span data-stu-id="35d4f-418">Patch and update</span></span>

<span data-ttu-id="35d4f-419">Процесс **исправления и обновления** в Службе Azure Kubernetes частично автоматизирован.</span><span class="sxs-lookup"><span data-stu-id="35d4f-419">The **Patch and Update (PNU)** process in Azure Kubernetes Service is partially automated.</span></span> <span data-ttu-id="35d4f-420">Обновления версии Kubernetes запускаются вручную, в то время как обновления безопасности применяются автоматически.</span><span class="sxs-lookup"><span data-stu-id="35d4f-420">Kubernetes version upgrades are triggered manually, while security updates are applied automatically.</span></span> <span data-ttu-id="35d4f-421">Учитываются такие обновления, как исправления безопасности для операционной системы и обновления ядра.</span><span class="sxs-lookup"><span data-stu-id="35d4f-421">These updates can include OS security fixes or kernel updates.</span></span> <span data-ttu-id="35d4f-422">AKS не выполняет автоматическую перезагрузку этих узлов Linux для завершения обновления.</span><span class="sxs-lookup"><span data-stu-id="35d4f-422">AKS doesn't automatically reboot these Linux nodes to complete the update process.</span></span> 

<span data-ttu-id="35d4f-423">Процесс PNU для кластера Kubernetes, развернутого с помощью обработчика AKS в Azure Stack Hub, является неуправляемым и контролируется оператором кластера.</span><span class="sxs-lookup"><span data-stu-id="35d4f-423">The PNU process for a Kubernetes cluster deployed using AKS Engine on Azure Stack Hub is unmanaged, and is the responsibility of the cluster operator.</span></span> 

<span data-ttu-id="35d4f-424">Обработчик AKS помогает выполнить две наиболее важные задачи:</span><span class="sxs-lookup"><span data-stu-id="35d4f-424">AKS Engine helps with the two most important tasks:</span></span>

- <span data-ttu-id="35d4f-425">[Обновление до новой версии Kubernetes и базового образа операционной системы](/azure-stack/user/azure-stack-kubernetes-aks-engine-upgrade#steps-to-upgrade-to-a-newer-kubernetes-version).</span><span class="sxs-lookup"><span data-stu-id="35d4f-425">[Upgrade to a newer Kubernetes and base OS image version](/azure-stack/user/azure-stack-kubernetes-aks-engine-upgrade#steps-to-upgrade-to-a-newer-kubernetes-version)</span></span>
- <span data-ttu-id="35d4f-426">[Обновление только версии базового образа операционной системы](/azure-stack/user/azure-stack-kubernetes-aks-engine-upgrade#steps-to-only-upgrade-the-os-image).</span><span class="sxs-lookup"><span data-stu-id="35d4f-426">[Upgrade the base OS image only](/azure-stack/user/azure-stack-kubernetes-aks-engine-upgrade#steps-to-only-upgrade-the-os-image)</span></span>

<span data-ttu-id="35d4f-427">Новые базовые образы операционной системы содержат последние исправления безопасности ОС и обновления ядра.</span><span class="sxs-lookup"><span data-stu-id="35d4f-427">Newer base OS images contain the latest OS security fixes and kernel updates.</span></span> 

<span data-ttu-id="35d4f-428">Механизм [автоматического обновления](https://wiki.debian.org/UnattendedUpgrades) автоматически устанавливает обновления для системы безопасности, выпущенные до появления новой версии базового образа ОС в Azure Stack Hub Marketplace.</span><span class="sxs-lookup"><span data-stu-id="35d4f-428">The [Unattended Upgrade](https://wiki.debian.org/UnattendedUpgrades) mechanism automatically installs security updates that are released before a new base OS image version is available in the Azure Stack Hub Marketplace.</span></span> <span data-ttu-id="35d4f-429">Этот механизм включен по умолчанию. Он автоматически устанавливает обновления безопасности, но не перезагружает узлы кластера Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="35d4f-429">Unattended upgrade is enabled by default and installs security updates automatically, but does not reboot the Kubernetes cluster nodes.</span></span> <span data-ttu-id="35d4f-430">Перезагрузку узлов можно автоматизировать с помощью [**K** Ubernetes **RE** boot **D** aemon (kured))](/azure/aks/node-updates-kured) с открытым кодом.</span><span class="sxs-lookup"><span data-stu-id="35d4f-430">Rebooting the nodes can be automated using the open-source [**K** Ubernetes **RE** boot **D** aemon (kured))](/azure/aks/node-updates-kured).</span></span> <span data-ttu-id="35d4f-431">Kured отслеживает узлы Linux, которые нужно перезагрузить, а затем автоматически корректирует расписание для перезагрузки выполняемых pod и узлов.</span><span class="sxs-lookup"><span data-stu-id="35d4f-431">Kured watches for Linux nodes that require a reboot, then automatically handle the rescheduling of running pods and node reboot process.</span></span>

## <a name="deployment-cicd-considerations"></a><span data-ttu-id="35d4f-432">Рекомендации по развертыванию (CI/CD)</span><span class="sxs-lookup"><span data-stu-id="35d4f-432">Deployment (CI/CD) considerations</span></span>

<span data-ttu-id="35d4f-433">Azure и Azure Stack Hub предоставляют те же REST API Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="35d4f-433">Azure and Azure Stack Hub expose the same Azure Resource Manager REST APIs.</span></span> <span data-ttu-id="35d4f-434">Эти API обрабатываются как любые другие облака Azure (Azure, Azure для Китая (21Vianet), Azure для государственных организаций).</span><span class="sxs-lookup"><span data-stu-id="35d4f-434">These APIs are addressed like any other Azure cloud (Azure, Azure China 21Vianet, Azure Government).</span></span> <span data-ttu-id="35d4f-435">В версиях API разных облаков могут быть различия, а Azure Stack Hub предоставляет только подмножество служб.</span><span class="sxs-lookup"><span data-stu-id="35d4f-435">There may be differences in API versions between clouds, and Azure Stack Hub provides only a subset of services.</span></span> <span data-ttu-id="35d4f-436">Универсальный код ресурса (URI) конечной точки управления также отличается для каждого облака и экземпляра Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-436">The management endpoint URI is also different for each cloud, and each instance of Azure Stack Hub.</span></span>

<span data-ttu-id="35d4f-437">Несмотря на незначительные различия, REST API Azure Resource Manager обеспечивают согласованный способ взаимодействия с Azure и Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-437">Aside from the subtle differences mentioned, Azure Resource Manager REST APIs provide a consistent way to interact with both Azure and Azure Stack Hub.</span></span> <span data-ttu-id="35d4f-438">Здесь можно использовать тот же набор средств, который используется с любым другим облаком Azure.</span><span class="sxs-lookup"><span data-stu-id="35d4f-438">The same set of tools can be used here as would be used with any other Azure cloud.</span></span> <span data-ttu-id="35d4f-439">Вы можете использовать средства Azure DevOps, такие как Jenkins или PowerShell, для развертывания служб и управления ими в Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-439">You can use Azure DevOps, tools like Jenkins, or PowerShell, to deploy and orchestrate services to Azure Stack Hub.</span></span>

<span data-ttu-id="35d4f-440">**Рекомендации**</span><span class="sxs-lookup"><span data-stu-id="35d4f-440">**Considerations**</span></span>

<span data-ttu-id="35d4f-441">Одним из основных отличий, связанных с развертыванием Azure Stack Hub, является доступность через Интернет.</span><span class="sxs-lookup"><span data-stu-id="35d4f-441">One of the major differences when it comes to Azure Stack Hub deployments is the question of Internet accessibility.</span></span> <span data-ttu-id="35d4f-442">Доступность через Интернет определяет, следует ли использовать для заданий непрерывной поставки и непрерывной интеграции агент сборки, размещенный в Майкрософт, или локальный агент сборки.</span><span class="sxs-lookup"><span data-stu-id="35d4f-442">Internet accessibility determines whether to select a Microsoft-hosted or a self-hosted build agent for your CI/CD jobs.</span></span>

<span data-ttu-id="35d4f-443">Локальный агент может выполняться в Azure Stack Hub (в качестве виртуальной машины IaaS) или в подсети, которая обеспечивает доступ к Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-443">A self-hosted agent can run on top of Azure Stack Hub (as an IaaS VM) or in a network subnet that can access Azure Stack Hub.</span></span> <span data-ttu-id="35d4f-444">Дополнительные сведения о различиях см. в статье [Агенты Azure Pipelines](/azure/devops/pipelines/agents/agents).</span><span class="sxs-lookup"><span data-stu-id="35d4f-444">Go to [Azure Pipelines agents](/azure/devops/pipelines/agents/agents) to learn more about the differences.</span></span>

<span data-ttu-id="35d4f-445">Информация, приведенная на следующем рисунке, поможет вам выбрать, следует ли использовать локальный агент сборки или агент сборки, размещенный в Майкрософт:</span><span class="sxs-lookup"><span data-stu-id="35d4f-445">The following image helps you to decide if you need a self-hosted or a Microsoft-hosted build agent:</span></span>

![Локальные агенты сборки (да или нет)](media/pattern-highly-available-kubernetes/aks-on-stack-self-hosted-build-agents-yes-or-no.png)

- <span data-ttu-id="35d4f-447">Доступны ли конечные точки управления Azure Stack Hub через Интернет?</span><span class="sxs-lookup"><span data-stu-id="35d4f-447">Are the Azure Stack Hub management endpoints accessible via Internet?</span></span>
  - <span data-ttu-id="35d4f-448">Да: для подключения к Azure Stack Hub можно использовать Azure Pipelines с агентами, размещенными в Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="35d4f-448">Yes: We can use Azure Pipelines with Microsoft-hosted agents to connect to Azure Stack Hub.</span></span>
  - <span data-ttu-id="35d4f-449">Нет: необходимо использовать локальные агенты, которые могут подключаться к конечным точкам управления Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-449">No: We need self-hosted agents that can connect to Azure Stack Hub's management endpoints.</span></span>
- <span data-ttu-id="35d4f-450">Доступен ли кластер Kubernetes через Интернет?</span><span class="sxs-lookup"><span data-stu-id="35d4f-450">Is our Kubernetes cluster accessible via the Internet?</span></span>
  - <span data-ttu-id="35d4f-451">Да: чтобы напрямую взаимодействовать с конечной точкой API Kubernetes, можно использовать Azure Pipelines с агентами, размещенными в Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="35d4f-451">Yes: We can use Azure Pipelines with Microsoft-hosted agents to interact directly with Kubernetes API endpoint.</span></span>
  - <span data-ttu-id="35d4f-452">Нет: необходимо использовать локальные агенты, которые могут подключаться к конечной точке API кластера Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="35d4f-452">No: We need self-hosted Agents that can connect to the Kubernetes cluster API endpoint.</span></span>

<span data-ttu-id="35d4f-453">В сценариях, где конечные точки управления Azure Stack Hub и API Kubernetes доступны через Интернет, при развертывании можно использовать агент, размещенный в Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="35d4f-453">In scenarios where the Azure Stack Hub management endpoints and Kubernetes API are accessible via the internet, the deployment can use a Microsoft-hosted agent.</span></span> <span data-ttu-id="35d4f-454">Это развертывание приведет к созданию следующей архитектуры приложения:</span><span class="sxs-lookup"><span data-stu-id="35d4f-454">This deployment will result in an application architecture as follows:</span></span>

<span data-ttu-id="35d4f-455">[![Обзор общей архитектуры](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern.png)](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern.png#lightbox)</span><span class="sxs-lookup"><span data-stu-id="35d4f-455">[![Public architecture overview](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern.png)](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern.png#lightbox)</span></span>

<span data-ttu-id="35d4f-456">Если конечные точки Azure Resource Manager, API Kubernetes или оба элемента недоступны напрямую через Интернет, можно использовать локальный агент сборки для выполнения шагов конвейера.</span><span class="sxs-lookup"><span data-stu-id="35d4f-456">If the Azure Resource Manager endpoints, Kubernetes API, or both aren't directly accessible via the Internet, we can leverage a self-hosted build agent to run the pipeline steps.</span></span> <span data-ttu-id="35d4f-457">Такая схема требует меньшего количества подключений и может быть развернута только посредством локального сетевого подключения к конечным точкам Azure Resource Manager и API Kubernetes:</span><span class="sxs-lookup"><span data-stu-id="35d4f-457">This design needs less connectivity, and can be deployed with only on-premises network connectivity to Azure Resource Manager endpoints and the Kubernetes API:</span></span>

<span data-ttu-id="35d4f-458">[![Обзор локальной архитектуры](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern-self-hosted.png)](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern-self-hosted.png#lightbox)</span><span class="sxs-lookup"><span data-stu-id="35d4f-458">[![On-prem architecture overview](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern-self-hosted.png)](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern-self-hosted.png#lightbox)</span></span>

> [!NOTE]
> <span data-ttu-id="35d4f-459">**Сведения о сценариях без подключения.**</span><span class="sxs-lookup"><span data-stu-id="35d4f-459">**What about disconnected scenarios?**</span></span> <span data-ttu-id="35d4f-460">В сценариях, где Azure Stack Hub, Kubernetes или оба экземпляра не имеют конечных точек управления с выходом в Интернет, для развертываний можно использовать DevOps Azure.</span><span class="sxs-lookup"><span data-stu-id="35d4f-460">In scenarios where either Azure Stack Hub or Kubernetes or both of them do not have internet-facing management endpoints, it is still possible to use Azure DevOps for your deployments.</span></span> <span data-ttu-id="35d4f-461">Вы можете использовать локально пул агентов (агент DevOps, работающий локально или в Azure Stack Hub) или полностью локальный сервер Azure DevOps Server.</span><span class="sxs-lookup"><span data-stu-id="35d4f-461">You can either use a self-hosted Agent Pool (which is a DevOps Agent running on-premises or on Azure Stack Hub itself) or a completly self-hosted Azure DevOps Server on-premises.</span></span> <span data-ttu-id="35d4f-462">Для локального агента требуется только исходящее подключение к Интернету по протоколу HTTPS (TCP/443).</span><span class="sxs-lookup"><span data-stu-id="35d4f-462">The self-hosted agent needs only outbound HTTPS (TCP/443) Internet connectivity.</span></span>

<span data-ttu-id="35d4f-463">Шаблон может использовать кластер Kubernetes (развернутый и управляемый с помощью обработчика AKS) в каждом экземпляре Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-463">The pattern can use a Kubernetes cluster (deployed and orchestrated with AKS engine) on each Azure Stack Hub instance.</span></span> <span data-ttu-id="35d4f-464">Сюда входят приложение, состоящее из внешнего интерфейса, службы среднего уровня, серверных служб (например, MongoDB), а также контроллер объекта ingress на основе NGINX.</span><span class="sxs-lookup"><span data-stu-id="35d4f-464">It includes an application consisting of a frontend, a mid-tier, backend services (for example MongoDB), and an nginx-based Ingress Controller.</span></span> <span data-ttu-id="35d4f-465">Вместо базы данных, размещенной в кластере K8s, используйте внешние хранилища данных.</span><span class="sxs-lookup"><span data-stu-id="35d4f-465">Instead of using a database hosted on the K8s cluster, you can leverage "external data stores".</span></span> <span data-ttu-id="35d4f-466">Варианты баз данных: MySQL, SQL Server или любая база данных, размещенная за пределами Azure Stack Hub или в IaaS.</span><span class="sxs-lookup"><span data-stu-id="35d4f-466">Database options include MySQL, SQL Server, or any kind of database hosted outside of Azure Stack Hub or in IaaS.</span></span> <span data-ttu-id="35d4f-467">Такие конфигурации не рассматриваются в этой статье.</span><span class="sxs-lookup"><span data-stu-id="35d4f-467">Configurations like this aren't in scope here.</span></span>

## <a name="partner-solutions"></a><span data-ttu-id="35d4f-468">Решения партнеров</span><span class="sxs-lookup"><span data-stu-id="35d4f-468">Partner solutions</span></span>

<span data-ttu-id="35d4f-469">Существуют решения партнеров Майкрософт, которые могут расширить возможности Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-469">There are Microsoft Partner solutions that can extend the capabilities of Azure Stack Hub.</span></span> <span data-ttu-id="35d4f-470">Эти решения полезны при развертывании приложений, работающих в кластерах Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="35d4f-470">These solutions have been found useful in deployments of applications running on Kubernetes clusters.</span></span>  

## <a name="storage-and-data-solutions"></a><span data-ttu-id="35d4f-471">Решения для работы с данными и хранилищами</span><span class="sxs-lookup"><span data-stu-id="35d4f-471">Storage and data solutions</span></span>

<span data-ttu-id="35d4f-472">Как описано в разделе [Рекомендации по работе с данными и хранилищем](#data-and-storage-considerations) в настоящее время в Azure Stack Hub нет собственного решения для репликации хранилища между несколькими экземплярами.</span><span class="sxs-lookup"><span data-stu-id="35d4f-472">As described in [Data and storage considerations](#data-and-storage-considerations), Azure Stack Hub currently doesn't have a native solution to replicate storage across multiple instances.</span></span> <span data-ttu-id="35d4f-473">В отличие от Azure, возможности репликации хранилища в нескольких регионах не существует.</span><span class="sxs-lookup"><span data-stu-id="35d4f-473">Unlike Azure, the capability of replicating storage across multiple regions does not exist.</span></span> <span data-ttu-id="35d4f-474">В Azure Stack Hub каждый экземпляр является отдельным облаком.</span><span class="sxs-lookup"><span data-stu-id="35d4f-474">In Azure Stack Hub, each instance is its own distinct cloud.</span></span> <span data-ttu-id="35d4f-475">Однако у партнеров Майкрософт есть решения, обеспечивающие репликацию хранилища в Azure Stack Hub и Azure.</span><span class="sxs-lookup"><span data-stu-id="35d4f-475">However, solutions are available from Microsoft Partners that enable storage replication across Azure Stack Hubs and Azure.</span></span> 

<span data-ttu-id="35d4f-476">**SCALITY**</span><span class="sxs-lookup"><span data-stu-id="35d4f-476">**SCALITY**</span></span>

<span data-ttu-id="35d4f-477">[Scality](https://www.scality.com/) предоставляет хранилище в масштабах Интернета, которое используется цифровыми предприятиями с 2009 года.</span><span class="sxs-lookup"><span data-stu-id="35d4f-477">[Scality](https://www.scality.com/) delivers web-scale storage that has powered digital businesses since 2009.</span></span> <span data-ttu-id="35d4f-478">Scality RING — это программно-определяемое хранилище, которое превращает стандартные серверы x86 в неограниченный пул носителей для любого типа данных, файлов и объектов в петабайтном масштабе.</span><span class="sxs-lookup"><span data-stu-id="35d4f-478">The Scality RING, our software-defined storage, turns commodity x86 servers into an unlimited storage pool for any type of data –file and object– at petabyte scale.</span></span>

<span data-ttu-id="35d4f-479">**CLOUDIAN**</span><span class="sxs-lookup"><span data-stu-id="35d4f-479">**CLOUDIAN**</span></span>

<span data-ttu-id="35d4f-480">[Cloudian](https://www.cloudian.com/) упрощает использование корпоративного хранилища с помощью неограниченного масштабируемого хранилища, объединяющего большие наборы данных в единую, легко управляемую среду.</span><span class="sxs-lookup"><span data-stu-id="35d4f-480">[Cloudian](https://www.cloudian.com/) simplifies enterprise storage with limitless scalable storage that consolidates massive data sets to a single, easily managed environment.</span></span>

## <a name="next-steps"></a><span data-ttu-id="35d4f-481">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="35d4f-481">Next steps</span></span>

<span data-ttu-id="35d4f-482">Дополнительные сведения по темам, описанным в этой статье:</span><span class="sxs-lookup"><span data-stu-id="35d4f-482">To learn more about concepts introduced in this article:</span></span>

- <span data-ttu-id="35d4f-483">[Масштабирование в разных облаках](pattern-cross-cloud-scale.md) и [шаблоны географически распределенных приложений](pattern-geo-distributed.md) в Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="35d4f-483">[Cross-cloud scaling](pattern-cross-cloud-scale.md) and [Geo-distributed app patterns](pattern-geo-distributed.md) in Azure Stack Hub.</span></span>
- <span data-ttu-id="35d4f-484">[Архитектура микрослужб в Службе Azure Kubernetes (AKS)](/azure/architecture/reference-architectures/microservices/aks)</span><span class="sxs-lookup"><span data-stu-id="35d4f-484">[Microservices architecture on Azure Kubernetes Service (AKS)](/azure/architecture/reference-architectures/microservices/aks).</span></span>

<span data-ttu-id="35d4f-485">Когда вы будете готовы протестировать пример решения, продолжите работу с [руководством по развертыванию кластеров Kubernetes с высоким уровнем доступности](solution-deployment-guide-highly-available-kubernetes.md).</span><span class="sxs-lookup"><span data-stu-id="35d4f-485">When you're ready to test the solution example, continue with the [High availability Kubernetes cluster deployment guide](solution-deployment-guide-highly-available-kubernetes.md).</span></span> <span data-ttu-id="35d4f-486">В этом руководстве содержатся пошаговые инструкции по развертыванию и тестированию компонентов.</span><span class="sxs-lookup"><span data-stu-id="35d4f-486">The deployment guide provides step-by-step instructions for deploying and testing its components.</span></span>