---
title: Шаблон решения для определения и анализа посещаемости в Azure и Azure Stack Hub
description: Узнайте, как с помощью Azure и Azure Stack Hub реализовать решение на основе искусственного интеллекта для определения и анализа посещаемости розничного магазина.
author: BryanLa
ms.topic: article
ms.date: 10/31/2019
ms.author: bryanla
ms.reviewer: anajod
ms.lastreviewed: 10/31/2019
ms.openlocfilehash: 0bf07bb38537f530a0adb3569c43d53af13b8d56
ms.sourcegitcommit: bb3e40b210f86173568a47ba18c3cc50d4a40607
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/17/2020
ms.locfileid: "84911222"
---
# <a name="footfall-detection-pattern"></a><span data-ttu-id="5287a-103">Шаблон определения посещаемости</span><span class="sxs-lookup"><span data-stu-id="5287a-103">Footfall detection pattern</span></span>

<span data-ttu-id="5287a-104">Этот шаблон демонстрирует реализацию решения на основе искусственного интеллекта для определения и анализа посещаемости розничного магазина.</span><span class="sxs-lookup"><span data-stu-id="5287a-104">This pattern provides an overview for implementing an AI-based footfall detection solution for analyzing visitor traffic in retail stores.</span></span> <span data-ttu-id="5287a-105">Решение создает полезные сведения на основе реальных действий, используя Azure, Azure Stack Hub и пакет средств разработки для искусственного интеллекта Пользовательского визуального распознавания.</span><span class="sxs-lookup"><span data-stu-id="5287a-105">The solution generates insights from real world actions, using Azure, Azure Stack Hub, and the Custom Vision AI Dev Kit.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="5287a-106">Контекст и проблема</span><span class="sxs-lookup"><span data-stu-id="5287a-106">Context and problem</span></span>

<span data-ttu-id="5287a-107">Компания Contoso хочет выяснить, как планировка ее магазинов влияет на выбор товаров посетителями.</span><span class="sxs-lookup"><span data-stu-id="5287a-107">Contoso Stores would like to gain insights on how customers are receiving their current products in relation to store layout.</span></span> <span data-ttu-id="5287a-108">Компания не может разместить сотрудников в каждом отделе. Неэффективным решением будет и нанять команду аналитиков для просмотра записей, полученных с камер магазинов.</span><span class="sxs-lookup"><span data-stu-id="5287a-108">They're unable to place staff in every section and it's inefficient to have a team of analysts review an entire store's camera footage.</span></span> <span data-ttu-id="5287a-109">Кроме того, ни один из их магазинов не имеет достаточной пропускной способности для потоковой передачи видео со всех своих камер в облако для анализа.</span><span class="sxs-lookup"><span data-stu-id="5287a-109">In addition, none of their stores have enough bandwidth to stream video from all their cameras to the cloud for analysis.</span></span>

<span data-ttu-id="5287a-110">Компания Contoso хочет найти ненавязчивый защищенный способ определения демографических данных, постоянных клиентов и их реакции на витрины и продукты.</span><span class="sxs-lookup"><span data-stu-id="5287a-110">Contoso would like to find an unobtrusive, privacy-friendly way to determine their customers' demographics, loyalty, and reactions to store displays and products.</span></span>

## <a name="solution"></a><span data-ttu-id="5287a-111">Решение</span><span class="sxs-lookup"><span data-stu-id="5287a-111">Solution</span></span>

<span data-ttu-id="5287a-112">Этот шаблон для розничной аналитики использует многоуровневый подход к формированию выводов на пограничных устройствах.</span><span class="sxs-lookup"><span data-stu-id="5287a-112">This retail analytics pattern uses a tiered approach to inferencing at the edge.</span></span> <span data-ttu-id="5287a-113">При использовании пакета средств разработки для искусственного интеллекта Пользовательского визуального распознавания для анализа в частном Azure Stack Hub, на котором запущены Azure Cognitive Services, отправляются только изображения с человеческими лицами.</span><span class="sxs-lookup"><span data-stu-id="5287a-113">By using the Custom Vision AI Dev Kit, only images with human faces are sent for analysis to a private Azure Stack Hub that runs Azure Cognitive Services.</span></span> <span data-ttu-id="5287a-114">Анонимные статистические данные со всех магазинов отправляются в Azure для агрегирования и визуализации в Power BI.</span><span class="sxs-lookup"><span data-stu-id="5287a-114">Anonymized, aggregated data is sent to Azure for aggregation across all stores and visualization in Power BI.</span></span> <span data-ttu-id="5287a-115">Объединение пограничных и общедоступных облаков позволяет компании Contoso использовать преимущества современных технологий на базе искусственного интеллекта, соблюдая требования своей корпоративной политики и уважая частную жизнь покупателей.</span><span class="sxs-lookup"><span data-stu-id="5287a-115">Combining the edge and public cloud lets Contoso take advantage of modern AI technology while also remaining in compliance with their corporate policies and respecting their customers' privacy.</span></span>

<span data-ttu-id="5287a-116">[![Шаблон решения для определения посещаемости](media/pattern-retail-footfall-detection/solution-architecture.png)](media/pattern-retail-footfall-detection/solution-architecture.png)</span><span class="sxs-lookup"><span data-stu-id="5287a-116">[![Footfall detection pattern solution](media/pattern-retail-footfall-detection/solution-architecture.png)](media/pattern-retail-footfall-detection/solution-architecture.png)</span></span>

<span data-ttu-id="5287a-117">Ниже приведены общие принципы работы решения.</span><span class="sxs-lookup"><span data-stu-id="5287a-117">Here's a summary of how the solution works:</span></span>

1. <span data-ttu-id="5287a-118">Пакет разработки для искусственного интеллекта Пользовательского визуального распознавания получает настройки из центра Интернета вещей, который устанавливает среду выполнения IoT Edge и модель машинного обучения.</span><span class="sxs-lookup"><span data-stu-id="5287a-118">The Custom Vision AI Dev Kit gets a configuration from IoT Hub, which installs the IoT Edge Runtime and an ML model.</span></span>
2. <span data-ttu-id="5287a-119">Если модель видит человека, она делает снимок и отправляет его в хранилище BLOB-объектов Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="5287a-119">If the model sees a person, it takes a picture and uploads it to Azure Stack Hub blob storage.</span></span>
3. <span data-ttu-id="5287a-120">Служба BLOB-объектов активирует Функцию Azure в Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="5287a-120">The blob service triggers an Azure Function on Azure Stack Hub.</span></span>
4. <span data-ttu-id="5287a-121">Функция Azure вызывает контейнер с API Распознавания лиц для получения демографических данных и данных распознавания эмоций из изображения.</span><span class="sxs-lookup"><span data-stu-id="5287a-121">The Azure Function calls a container with the Face API to get demographic and emotion data from the image.</span></span>
5. <span data-ttu-id="5287a-122">Данные обезличиваются и отправляются в кластер Центров событий Azure.</span><span class="sxs-lookup"><span data-stu-id="5287a-122">The data is anonymized and sent to an Azure Event Hubs cluster.</span></span>
6. <span data-ttu-id="5287a-123">Кластер Центров событий отправляет данные в Stream Analytics.</span><span class="sxs-lookup"><span data-stu-id="5287a-123">The Event Hubs cluster pushes the data to Stream Analytics.</span></span>
7. <span data-ttu-id="5287a-124">Stream Analytics выполняет статистическую обработку данных и отправляет их в Power BI.</span><span class="sxs-lookup"><span data-stu-id="5287a-124">Stream Analytics aggregates the data and pushes it to Power BI.</span></span>

## <a name="components"></a><span data-ttu-id="5287a-125">Components</span><span class="sxs-lookup"><span data-stu-id="5287a-125">Components</span></span>

<span data-ttu-id="5287a-126">Это решение использует следующие компоненты.</span><span class="sxs-lookup"><span data-stu-id="5287a-126">This solution uses the following components:</span></span>

| <span data-ttu-id="5287a-127">Уровень</span><span class="sxs-lookup"><span data-stu-id="5287a-127">Layer</span></span> | <span data-ttu-id="5287a-128">Компонент</span><span class="sxs-lookup"><span data-stu-id="5287a-128">Component</span></span> | <span data-ttu-id="5287a-129">Описание</span><span class="sxs-lookup"><span data-stu-id="5287a-129">Description</span></span> |
|----------|-----------|-------------|
| <span data-ttu-id="5287a-130">Оборудование в магазине</span><span class="sxs-lookup"><span data-stu-id="5287a-130">In-store hardware</span></span> | [<span data-ttu-id="5287a-131">Пакет разработки для искусственного интеллекта Пользовательского визуального распознавания</span><span class="sxs-lookup"><span data-stu-id="5287a-131">Custom Vision AI Dev Kit</span></span>](https://azure.github.io/Vision-AI-DevKit-Pages/) | <span data-ttu-id="5287a-132">Обеспечивает фильтрацию снимков в магазине с помощью локальной модели машинного обучения, которая фиксирует только изображения людей для анализа.</span><span class="sxs-lookup"><span data-stu-id="5287a-132">Provides in-store filtering using a local ML model that only captures images of people for analysis.</span></span> <span data-ttu-id="5287a-133">Безопасная подготовка и обновление с помощью Центра Интернета вещей.</span><span class="sxs-lookup"><span data-stu-id="5287a-133">Securely provisioned and updated through IoT Hub.</span></span><br><br>|
| <span data-ttu-id="5287a-134">Azure</span><span class="sxs-lookup"><span data-stu-id="5287a-134">Azure</span></span> | [<span data-ttu-id="5287a-135">Центры событий Azure</span><span class="sxs-lookup"><span data-stu-id="5287a-135">Azure Event Hubs</span></span>](/azure/event-hubs/) | <span data-ttu-id="5287a-136">Концентраторы событий Azure предоставляют масштабируемую платформу для приема анонимных данных, которые корректно интегрируются с Azure Stream Analytics.</span><span class="sxs-lookup"><span data-stu-id="5287a-136">Azure Event Hubs provides a scalable platform for ingesting anonymized data that integrates neatly with Azure Stream Analytics.</span></span> |
|  | [<span data-ttu-id="5287a-137">Azure Stream Analytics</span><span class="sxs-lookup"><span data-stu-id="5287a-137">Azure Stream Analytics</span></span>](/azure/stream-analytics/) | <span data-ttu-id="5287a-138">Задание Azure Stream Analytics выполняет статистическую обработку анонимных данных и группирует их в 15-секундные окна для визуализации.</span><span class="sxs-lookup"><span data-stu-id="5287a-138">An Azure Stream Analytics job aggregates the anonymized data and groups it into 15-second windows for visualization.</span></span> |
|  | [<span data-ttu-id="5287a-139">Microsoft Power BI</span><span class="sxs-lookup"><span data-stu-id="5287a-139">Microsoft Power BI</span></span>](https://powerbi.microsoft.com/) | <span data-ttu-id="5287a-140">Power BI предоставляет простой в использовании интерфейс панели мониторинга для просмотра выходных данных Azure Stream Analytics.</span><span class="sxs-lookup"><span data-stu-id="5287a-140">Power BI provides an easy-to-use dashboard interface for viewing the output from Azure Stream Analytics.</span></span> |
| <span data-ttu-id="5287a-141">Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="5287a-141">Azure Stack Hub</span></span> | [<span data-ttu-id="5287a-142">Служба приложений</span><span class="sxs-lookup"><span data-stu-id="5287a-142">App Service</span></span>](/azure-stack/operator/azure-stack-app-service-overview.md) | <span data-ttu-id="5287a-143">Поставщик ресурсов Службы приложений предоставляет основу для компонентов пограничной среды, включая функции размещения и управления для веб-приложений, API и функций.</span><span class="sxs-lookup"><span data-stu-id="5287a-143">The App Service resource provider (RP) provides a base for edge components, including hosting and management features for web apps/APIs and Functions.</span></span> |
| | <span data-ttu-id="5287a-144">Кластер [обработчика](https://github.com/Azure/aks-engine) Службы Azure Kubernetes (AKS).</span><span class="sxs-lookup"><span data-stu-id="5287a-144">Azure Kubernetes Service [(AKS) Engine](https://github.com/Azure/aks-engine) cluster</span></span> | <span data-ttu-id="5287a-145">Поставщик ресурсов AKS с кластером обработчика AKS, развернутым в Azure Stack Hub, предоставляет масштабируемый отказоустойчивый механизм для запуска контейнера API Распознавания лиц.</span><span class="sxs-lookup"><span data-stu-id="5287a-145">The AKS RP with AKS-Engine cluster deployed into Azure Stack Hub provides a scalable, resilient engine to run the Face API container.</span></span> |
| | <span data-ttu-id="5287a-146">[Контейнеры API Распознавания лиц](/azure/cognitive-services/face/face-how-to-install-containers) Cognitive Services в Azure</span><span class="sxs-lookup"><span data-stu-id="5287a-146">Azure Cognitive Services [Face API containers](/azure/cognitive-services/face/face-how-to-install-containers)</span></span>| <span data-ttu-id="5287a-147">Поставщик ресурсов Azure Cognitive Services с контейнерами API Распознавания лиц предоставляет демографические данные, данные распознавания эмоций и уникальные определения посетителей в закрытой сети Contoso.</span><span class="sxs-lookup"><span data-stu-id="5287a-147">The Azure Cognitive Services RP with Face API containers provides demographic, emotion, and unique visitor detection on Contoso's private network.</span></span> |
| | <span data-ttu-id="5287a-148">Хранилище BLOB-объектов</span><span class="sxs-lookup"><span data-stu-id="5287a-148">Blob Storage</span></span> | <span data-ttu-id="5287a-149">Изображения, полученные из пакета средств разработки для искусственного интеллекта, отправляются в хранилище BLOB-объектов Azure Stack Hub.</span><span class="sxs-lookup"><span data-stu-id="5287a-149">Images captured from the AI Dev Kit are uploaded to Azure Stack Hub's blob storage.</span></span> |
| | <span data-ttu-id="5287a-150">Функции Azure</span><span class="sxs-lookup"><span data-stu-id="5287a-150">Azure Functions</span></span> | <span data-ttu-id="5287a-151">Функция Azure, выполняемая в Azure Stack Hub, получает входные данные из хранилища BLOB-объектов и управляет взаимодействиями с API Распознавания лиц.</span><span class="sxs-lookup"><span data-stu-id="5287a-151">An Azure Function running on Azure Stack Hub receives input from blob storage and manages the interactions with the Face API.</span></span> <span data-ttu-id="5287a-152">API выдает анонимные данные в кластер Центров событий, расположенный в Azure.</span><span class="sxs-lookup"><span data-stu-id="5287a-152">It emits anonymized data to an Event Hubs cluster located in Azure.</span></span><br><br>|

## <a name="issues-and-considerations"></a><span data-ttu-id="5287a-153">Проблемы и рекомендации</span><span class="sxs-lookup"><span data-stu-id="5287a-153">Issues and considerations</span></span>

<span data-ttu-id="5287a-154">Во время выбора варианта реализации этого решения необходимо учитывать приведенные ниже моменты.</span><span class="sxs-lookup"><span data-stu-id="5287a-154">Consider the following points when deciding how to implement this solution:</span></span>

### <a name="scalability"></a><span data-ttu-id="5287a-155">Масштабируемость</span><span class="sxs-lookup"><span data-stu-id="5287a-155">Scalability</span></span>

<span data-ttu-id="5287a-156">Чтобы это решение можно было масштабировать на несколько камер и расположений, необходимо убедиться, что все компоненты могут справиться с повышенной нагрузкой.</span><span class="sxs-lookup"><span data-stu-id="5287a-156">To enable this solution to scale across multiple cameras and locations, you'll need to make sure that all of the components can handle the increased load.</span></span> <span data-ttu-id="5287a-157">Может потребоваться выполнить следующее:</span><span class="sxs-lookup"><span data-stu-id="5287a-157">You may need to take actions like:</span></span>

- <span data-ttu-id="5287a-158">увеличить число единиц потоковой передачи Stream Analytics;</span><span class="sxs-lookup"><span data-stu-id="5287a-158">Increase the number of Stream Analytics streaming units.</span></span>
- <span data-ttu-id="5287a-159">горизонтально увеличить масштаб развертывания API Распознавания лиц;</span><span class="sxs-lookup"><span data-stu-id="5287a-159">Scale out the Face API deployment.</span></span>
- <span data-ttu-id="5287a-160">увеличить пропускную способность кластера Центров событий;</span><span class="sxs-lookup"><span data-stu-id="5287a-160">Increase the Event Hubs cluster throughput.</span></span>
- <span data-ttu-id="5287a-161">В крайних случаях может потребоваться перенести данные из Функций Azure на виртуальную машину.</span><span class="sxs-lookup"><span data-stu-id="5287a-161">For extreme cases, migrate from Azure Functions to a virtual machine may be necessary.</span></span>

### <a name="availability"></a><span data-ttu-id="5287a-162">Доступность</span><span class="sxs-lookup"><span data-stu-id="5287a-162">Availability</span></span>

<span data-ttu-id="5287a-163">Так как это решение распределено по уровням, важно подумать о том, как справляться с сетевыми сбоями или отключениями электропитания.</span><span class="sxs-lookup"><span data-stu-id="5287a-163">Since this solution is tiered, it's important to think about how to deal with networking or power failures.</span></span> <span data-ttu-id="5287a-164">В зависимости от бизнес-требований вы можете реализовать механизм, который локально кэширует изображения, а затем перенаправляет их в Azure Stack Hub при восстановлении подключения.</span><span class="sxs-lookup"><span data-stu-id="5287a-164">Depending on business needs, you might want to implement a mechanism to cache images locally, then forward to Azure Stack Hub when connectivity returns.</span></span> <span data-ttu-id="5287a-165">Если расположение достаточно велико, лучше всего развернуть в этом расположении Data Box Edge с контейнером API Распознавания лиц.</span><span class="sxs-lookup"><span data-stu-id="5287a-165">If the location is large enough, deploying a Data Box Edge with the Face API container to that location might be a better option.</span></span>

### <a name="manageability"></a><span data-ttu-id="5287a-166">Управляемость</span><span class="sxs-lookup"><span data-stu-id="5287a-166">Manageability</span></span>

<span data-ttu-id="5287a-167">Это решение может масштабироваться на множество устройств и расположений, что может оказаться неудобным.</span><span class="sxs-lookup"><span data-stu-id="5287a-167">This solution can span many devices and locations, which could get unwieldy.</span></span> <span data-ttu-id="5287a-168">[Службы Интернета вещей Azure](/azure/iot-fundamentals/) можно использовать для автоматического перевода новых расположений и устройств в режим подключения и их обновления.</span><span class="sxs-lookup"><span data-stu-id="5287a-168">[Azure's IoT services](/azure/iot-fundamentals/) can be used to automatically bring new locations and devices online and keep them up to date.</span></span>

### <a name="security"></a><span data-ttu-id="5287a-169">Безопасность</span><span class="sxs-lookup"><span data-stu-id="5287a-169">Security</span></span>

<span data-ttu-id="5287a-170">Это решение собирает изображения клиентов, уделяя особое внимание безопасности.</span><span class="sxs-lookup"><span data-stu-id="5287a-170">This solution captures customer images, making security a paramount consideration.</span></span> <span data-ttu-id="5287a-171">Убедитесь, что все учетные записи хранения защищены с помощью соответствующих политик доступа и периодически меняйте ключи.</span><span class="sxs-lookup"><span data-stu-id="5287a-171">Make sure all storage accounts are secured with the proper access policies and rotate keys regularly.</span></span> <span data-ttu-id="5287a-172">Убедитесь, что для учетных записей хранения и концентраторов событий имеются политики хранения, соответствующие корпоративным и правительственным нормам конфиденциальности.</span><span class="sxs-lookup"><span data-stu-id="5287a-172">Ensure storage accounts and Event Hubs have retention policies that meet corporate and government privacy regulations.</span></span> <span data-ttu-id="5287a-173">Кроме того, убедитесь, что уровни доступа пользователей настроены по уровням.</span><span class="sxs-lookup"><span data-stu-id="5287a-173">Also make sure to tier the user access levels.</span></span> <span data-ttu-id="5287a-174">Таким образом, пользователи будут иметь доступ только к тем данным, которые необходимы для их роли.</span><span class="sxs-lookup"><span data-stu-id="5287a-174">Tiering ensures that users only have access to the data they need for their role.</span></span>

## <a name="next-steps"></a><span data-ttu-id="5287a-175">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="5287a-175">Next steps</span></span>

<span data-ttu-id="5287a-176">Дополнительные сведения о разделах, представленных в этой статье:</span><span class="sxs-lookup"><span data-stu-id="5287a-176">To learn more about the topics introduced in this article:</span></span>

- <span data-ttu-id="5287a-177">См. сведения о [шаблоне распределения данных по уровням](https://aka.ms/tiereddatadeploy), используемым шаблоном определения посещаемости.</span><span class="sxs-lookup"><span data-stu-id="5287a-177">See the [Tiered Data pattern](https://aka.ms/tiereddatadeploy), which is leveraged by the footfall detection pattern.</span></span>
- <span data-ttu-id="5287a-178">Дополнительные сведения о пакете разработки для искусственного интеллекта Пользовательского визуального распознавания см. в [этой статье](https://azure.github.io/Vision-AI-DevKit-Pages/).</span><span class="sxs-lookup"><span data-stu-id="5287a-178">See the [Custom Vision AI Dev Kit](https://azure.github.io/Vision-AI-DevKit-Pages/) to learn more about using custom vision.</span></span> 

<span data-ttu-id="5287a-179">Когда вы будете готовы протестировать пример решения, продолжите работу с [руководством по развертыванию решения для определения посещаемости](solution-deployment-guide-retail-footfall-detection.md).</span><span class="sxs-lookup"><span data-stu-id="5287a-179">When you're ready to test the solution example, continue with the [Footfall detection deployment guide](solution-deployment-guide-retail-footfall-detection.md).</span></span> <span data-ttu-id="5287a-180">В этом руководстве содержатся пошаговые инструкции по развертыванию и тестированию компонентов.</span><span class="sxs-lookup"><span data-stu-id="5287a-180">The deployment guide provides step-by-step instructions for deploying and testing its components.</span></span>
